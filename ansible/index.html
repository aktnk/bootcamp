<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ansibleでホストの構成管理 | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="IIJ で実施している新人向けのハンズオン資料集です。">
    <link rel="preload" href="/bootcamp/assets/css/0.styles.d919bf53.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.b03fadc6.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.b1640ebb.js" as="script"><link rel="preload" href="/bootcamp/assets/js/12.a47c18a6.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.ad61ea90.js"><link rel="prefetch" href="/bootcamp/assets/js/11.be90c56e.js"><link rel="prefetch" href="/bootcamp/assets/js/13.4cb8e4e0.js"><link rel="prefetch" href="/bootcamp/assets/js/14.dea1bb3a.js"><link rel="prefetch" href="/bootcamp/assets/js/15.472a3b78.js"><link rel="prefetch" href="/bootcamp/assets/js/16.f310fab1.js"><link rel="prefetch" href="/bootcamp/assets/js/17.a6c3f026.js"><link rel="prefetch" href="/bootcamp/assets/js/18.0a68b0f3.js"><link rel="prefetch" href="/bootcamp/assets/js/19.823cb998.js"><link rel="prefetch" href="/bootcamp/assets/js/20.98b2a23b.js"><link rel="prefetch" href="/bootcamp/assets/js/21.3da42a73.js"><link rel="prefetch" href="/bootcamp/assets/js/22.d9658bad.js"><link rel="prefetch" href="/bootcamp/assets/js/23.7bf16806.js"><link rel="prefetch" href="/bootcamp/assets/js/24.b63757cc.js"><link rel="prefetch" href="/bootcamp/assets/js/25.301feef1.js"><link rel="prefetch" href="/bootcamp/assets/js/26.8dca49c5.js"><link rel="prefetch" href="/bootcamp/assets/js/27.cbc7cb22.js"><link rel="prefetch" href="/bootcamp/assets/js/28.9b1cfccd.js"><link rel="prefetch" href="/bootcamp/assets/js/29.54e6472c.js"><link rel="prefetch" href="/bootcamp/assets/js/3.2392f718.js"><link rel="prefetch" href="/bootcamp/assets/js/30.e39cf39f.js"><link rel="prefetch" href="/bootcamp/assets/js/31.689d8076.js"><link rel="prefetch" href="/bootcamp/assets/js/32.a71bde8b.js"><link rel="prefetch" href="/bootcamp/assets/js/33.c92dc95b.js"><link rel="prefetch" href="/bootcamp/assets/js/34.c724da90.js"><link rel="prefetch" href="/bootcamp/assets/js/35.3e848aa9.js"><link rel="prefetch" href="/bootcamp/assets/js/4.89476b16.js"><link rel="prefetch" href="/bootcamp/assets/js/5.ad4499c7.js"><link rel="prefetch" href="/bootcamp/assets/js/6.21d4d19d.js"><link rel="prefetch" href="/bootcamp/assets/js/7.7518d232.js"><link rel="prefetch" href="/bootcamp/assets/js/8.833c626f.js"><link rel="prefetch" href="/bootcamp/assets/js/9.00dc8e3a.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.d919bf53.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ansibleでホストの構成管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/ansible/#_0-この講義について" class="sidebar-link">0. この講義について</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#下準備" class="sidebar-link">下準備</a></li><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#ネットワーク構成" class="sidebar-link">ネットワーク構成</a></li></ul></li><li><a href="/bootcamp/ansible/#_1-ansibleとは" class="sidebar-link">1. Ansibleとは</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#サンプル実行" class="sidebar-link">サンプル実行</a></li></ul></li><li><a href="/bootcamp/ansible/#_2-ケース1-リバースプロキシの導入" class="sidebar-link">2. [ケース1] リバースプロキシの導入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#ディレクトリ構造" class="sidebar-link">ディレクトリ構造</a></li><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#ファイル編集" class="sidebar-link">ファイル編集</a></li><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#実行" class="sidebar-link">実行</a></li></ul></li><li><a href="/bootcamp/ansible/#_3-ケース2-バージョンアップ-スケーリング" class="sidebar-link">3. [ケース2] バージョンアップ &amp; スケーリング</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#バージョンアップ" class="sidebar-link">バージョンアップ</a></li><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#スケールアップ" class="sidebar-link">スケールアップ</a></li></ul></li><li><a href="/bootcamp/ansible/#_4-応用課題-aclの導入" class="sidebar-link">4. [応用課題] ACLの導入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#ヒント" class="sidebar-link">ヒント</a></li><li class="sidebar-sub-header"><a href="/bootcamp/ansible/#解答例" class="sidebar-link">解答例</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ansibleでホストの構成管理"><a href="#ansibleでホストの構成管理" class="header-anchor">#</a> ansibleでホストの構成管理</h1> <h2 id="_0-この講義について"><a href="#_0-この講義について" class="header-anchor">#</a> 0. この講義について</h2> <p>この講義ではハンズオン形式でAnsibleについて学びます。
ハンズオン用の教材は<a href="https://github.com/iij/ansible-exercise" target="_blank" rel="noopener noreferrer">こちら<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>になります。</p> <h3 id="下準備"><a href="#下準備" class="header-anchor">#</a> 下準備</h3> <p>この講義を受けるにはいくつかの環境準備が必要です。
教材のREADMEに従い、講義当日までに環境を整えてください。</p> <h3 id="ネットワーク構成"><a href="#ネットワーク構成" class="header-anchor">#</a> ネットワーク構成</h3> <p>この講義で使用するコンテナのネットワーク図です。
コンテナをVM（Virtual Machine）に見立て、ハンズオンを実施します。</p> <p><img src="/bootcamp/assets/img/network.866df4b8.png" alt="ネットワーク図"></p> <p>この講義では図中のansibleコンテナから各ホストを管理します。</p> <h2 id="_1-ansibleとは"><a href="#_1-ansibleとは" class="header-anchor">#</a> 1. Ansibleとは</h2> <p>公式ドキュメント: <a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank" rel="noopener noreferrer">https://docs.ansible.com/ansible/latest/index.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Ansibleとは、IT自動化ツールです。
サーバの設定やアプリケーションのデプロイなど、さまざまな処理を自動化できます。
<code>IaC（Infrastructure as Code）</code>から生まれたツールで、<a href="https://yaml.org/" target="_blank" rel="noopener noreferrer">YAML<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>と呼ばれる記述（解読）のしやすい言語で書くことができるため、
サーバなどに詳しくない人にも理解しやすいです。
またサーバなどの状態がファイルとして記述されるため、アプリケーションのソースコードと同様にGitなどでバージョン管理できます。</p> <p>Ansibleが実際にサーバを管理する際、基本的には<a href="https://www.openssh.com/" target="_blank" rel="noopener noreferrer">OpenSSH<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を使って対象サーバへアクセスします。
OpenSSHは多くのサーバにデフォルトでインストールされており、Ansible独自のデーモンをインストールする手間もなく導入しやすいです。</p> <p>またモジュールやプラグインも多く、数多くの処理を自動化できます。</p> <ul><li><a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html" target="_blank" rel="noopener noreferrer">モジュール一覧<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.ansible.com/ansible/latest/plugins/plugins.html" target="_blank" rel="noopener noreferrer">プラグイン一覧<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="サンプル実行"><a href="#サンプル実行" class="header-anchor">#</a> サンプル実行</h3> <p>まずは実際にAnsibleを実行してみましょう。</p> <p>ダウンロードした<a href="https://github.com/iij/ansible-exercise" target="_blank" rel="noopener noreferrer">教材<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>のフォルダ内で下記コマンドを実行しコンテナ内に入る、
またはVScodeの<code>Remote - Containers</code>を使い教材のフォルダを開き、コンテナ内に入ります。</p> <p>Windows</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>docker<span class="token operator">-</span>compose <span class="token operator">-</span>f docker<span class="token operator">-</span>compose\docker<span class="token operator">-</span>compose<span class="token punctuation">.</span>yml <span class="token function">start</span>
docker exec <span class="token operator">-</span>it docker<span class="token operator">-</span>compose_ansible_1 bash
</code></pre></div><p>Mac/Linux</p> <div class="language-sh extra-class"><pre class="language-sh"><code>docker-compose -f docker-compose/docker-compose.yml up -d
docker <span class="token builtin class-name">exec</span> -it docker-compose_ansible_1 <span class="token function">bash</span>
</code></pre></div><p>Ansibleで主に使うコマンドは<code>ansible</code>と<code>ansible-playbook</code>の2つです。</p> <p><a href="https://docs.ansible.com/ansible/latest/cli/ansible.html" target="_blank" rel="noopener noreferrer">ansibleコマンド<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>はアドホックにAnsibeを実行できます。
YAMLなどのファイルを用意しなくても良いので、細かな日々の運用作業や確認作業などに使えます。</p> <p><a href="https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html" target="_blank" rel="noopener noreferrer">ansible-playbookコマンド<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>は<code>playbook</code>と呼ばれるYAMLファイルにしたがってAnsibleを実行するコマンドになります。
基本的にAnsibleを実行する際は、こちらのコマンドを使います。
このハンズオンでも主に<code>ansible-playbook</code>コマンドを使っていきます。</p> <p>それではまずは何のファイルも編集せずに、下記のコマンドをコンテナ内で実行し、Ansibleを実行してみましょう。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible-playbook -C site.yml
</code></pre></div><p>最後に<code>failed=0</code>と表示されていれば実行は成功です。
教材の中にはすでに、データベース（MySQL）とJavaアプリケーションを構築するためのファイルが用意されています。
したがってそのまま実行するだけで、MySQLとJavaのアプリケーションがそれぞれのホスト内で起動します。</p> <p>それでは<a href="http://localhost:8080" target="_blank" rel="noopener noreferrer">http://localhost:8080<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にブラウザでアクセスしてみましょう！</p> <p>...</p> <p>何も表示されないですね。</p> <p>それもそのはずです。
さきほど実行したコマンドは<code>dryrun</code>すなわち、実際にデータベースやJavaアプリケーションをAnsibleが構築したのではありません。
Ansibleが「もしも実行していたらこういう結果になる」というログを表示しただけです。
したがって実際の処理は行われていないので、当然アプリケーションにもアクセスできません。</p> <p><strong>Ansibleの良さの1つがこの<code>dryrun</code>です。</strong>
実際にAnsibleを実行したときとほぼ同じ内容を得ることができるため、作業ミスを防ぐことができます。</p> <p>さて、では下記コマンドを実行して今度こそデータベースとアプリケーションを構築しましょう。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible-playbook site.yml
</code></pre></div><p><code>failed=0</code>と表示されれば実行は成功です。
ブラウザで<a href="http://loclahost:8080" target="_blank" rel="noopener noreferrer">http://loclahost:8080<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にアクセスすると素朴なWebアプリケーションの画面が見えます。
また、下記コマンドでホストに対して実際にファイルがコピーされていることが確認できます。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># MySQL config file</span>
ansible db1 -m <span class="token builtin class-name">command</span> -a <span class="token string">'cat /etc/my.cnf'</span>

<span class="token comment"># app jar file</span>
ansible app1 -m <span class="token builtin class-name">command</span> -a <span class="token string">'ls -l /opt/ansible-exercise/app.jar'</span>
</code></pre></div><p>もうお気付きの人もいると思いますが、コマンドのオプションに<code>-C（--check）</code>を渡すことで<code>dryrun</code>を行うことができます。
したがって一般的な使い方としては、<code>-C（--check）</code>を付けてコマンドを実行し問題がないかを確認した後、
<code>-C（--check）</code>を外して再度コマンドを実行して、本構築を行うという流れになります。</p> <p>また、さきほど登場した<code>playbook</code>と呼ばれるYAMLファイルが<code>site.yml</code>になります。</p> <p>Ansibleの使い方が分かったところで、いよいよファイルの作り方について学んでいきましょう。</p> <h2 id="_2-ケース1-リバースプロキシの導入"><a href="#_2-ケース1-リバースプロキシの導入" class="header-anchor">#</a> 2. [ケース1] リバースプロキシの導入</h2> <p>さきほどのセクションで構築したデータベースとアプリケーションを流用します。
現在の状態は、ブラウザから直接アプリケーションに<code>HTTP</code>でアクセスしている状態です。
nginxを導入し、<code>HTTPS</code>でアクセスしてみましょう。</p> <h3 id="ディレクトリ構造"><a href="#ディレクトリ構造" class="header-anchor">#</a> ディレクトリ構造</h3> <p>まず、ディレクトリ構造とそれぞれの役割について説明します。
下記は教材のディレクトリ構造の一部抜粋です。
Ansibleに関わるファイルやディレクトリのみを抜粋しています。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>├── ansible.cfg  <span class="token comment"># Ansibleの設定ファイル</span>
├── inventories  <span class="token comment"># 管理対象サーバの情報を格納するディレクトリ</span>
│   ├── group_vars  <span class="token comment"># グループごとの変数ファイルを格納するファイル</span>
│   │   └── all.yml  <span class="token comment"># すべてのグループに適用される変数ファイル</span>
│   └── hosts  <span class="token comment"># サーバのIPやSSHのユーザやグループなどを記述するファイル</span>
├── playbooks  <span class="token comment"># 実行用ファイルを格納するディレクトリ。各ファイルはsite.ymlからインポートします。</span>
│   ├── acl.yml
│   ├── app.yml
│   ├── db.yml
│   └── rp.yml
├── roles  <span class="token comment"># ロールを格納するディレクトリ。Ansibleの実行はロールと呼ばれるまとまりで管理されます。</span>
│   └── webapp
│       ├── defaults
│       │   └── main.yml  <span class="token comment"># ロール内で使用される変数のデフォルト値を定義するファイル</span>
│       ├── files  <span class="token comment"># サーバへ配布したいファイルを格納するディレクトリ</span>
│       ├── handlers
│       │   └── main.yml  <span class="token comment"># ハンドラタスクを定義するファイル</span>
│       ├── tasks
│       │   └── main.yml  <span class="token comment"># Ansibleの具体的な処理内容を記述するファイル</span>
│       └── templates  <span class="token comment"># サーバへ配布したいJinja2テンプレートを使ったファイルを格納するディレクトリ</span>
├── site.yml  <span class="token comment"># playbookファイル</span>
└── vars
    └── proxy.yml  <span class="token comment"># Proxy配下でハンズオンを実施するためのファイル</span>
</code></pre></div><p>さらに詳しく知りたい人はAnsibleの<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html" target="_blank" rel="noopener noreferrer">ベストプラクティス<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください。</p> <h3 id="ファイル編集"><a href="#ファイル編集" class="header-anchor">#</a> ファイル編集</h3> <p>それではファイルを作成してみましょう。
TLSの証明書に加え、いくつかの設定ファイルはすでに用意してあります。
皆さんには下記4つのファイルを編集してもらいます。</p> <h4 id="roles-nginx-tasks-main-yml"><a href="#roles-nginx-tasks-main-yml" class="header-anchor">#</a> roles/nginx/tasks/main.yml</h4> <p>nginxを構築するためのタスクファイルです。
<a href="http://nginx.org/en/linux_packages.html#RHEL-CentOS" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>のインストール手順に加え、設定ファイルや証明書の配布を行っています。</p> <p>Ansibleはモジュールと呼ばれるものを使って、さまざまな処理を行います。
Ansibleに組込み済みのモジュールは<a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にリストアップされており、各モジュールごとの書き方が載っています。
モジュールを自作して使うこともできますが、基本的には上記のサイトから行いたい処理に合ったモジュールを探し、タスクファイルを作ります。</p> <p>下記の内容を教材の<code>roles/nginx/tasks/main.yml</code>にコピーしましょう。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install yum<span class="token punctuation">-</span>utils
  <span class="token key atrule">yum</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> yum<span class="token punctuation">-</span>utils
    <span class="token key atrule">state</span><span class="token punctuation">:</span> present
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ proxy_env | default({}) }}&quot;</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add Nginx repository
  <span class="token key atrule">yum_repository</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>stable
    <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">'nginx stable repo'</span>
    <span class="token key atrule">baseurl</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//nginx.org/packages/centos/$releasever/$basearch/
    <span class="token key atrule">gpgkey</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//nginx.org/keys/nginx_signing.key
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> yes

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install Nginx
  <span class="token key atrule">yum</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;nginx-{{ nginx_version }}-1.el7.ngx.x86_64&quot;</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> present
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ proxy_env | default({}) }}&quot;</span>
  <span class="token key atrule">ignore_errors</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ ansible_check_mode }}&quot;</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create ssl directory
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/nginx/ssl
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
    <span class="token key atrule">group</span><span class="token punctuation">:</span> root
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0600</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy ssl files
  <span class="token key atrule">copy</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">&quot;etc/nginx/ssl/{{ item }}&quot;</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/nginx/ssl/{{ item }}&quot;</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0400</span>
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> server.crt
    <span class="token punctuation">-</span> server.key
    <span class="token punctuation">-</span> dhparam.pem

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> remove default config file
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> absent
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/nginx/conf.d/default.conf
  <span class="token key atrule">notify</span><span class="token punctuation">:</span> reload nginx

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy config file
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> etc/nginx/conf.d/app.conf.j2
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/conf.d/app.conf
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
    <span class="token key atrule">group</span><span class="token punctuation">:</span> root
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0644</span>
  <span class="token key atrule">notify</span><span class="token punctuation">:</span> reload nginx

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start nginx
  <span class="token key atrule">systemd</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">state</span><span class="token punctuation">:</span> started
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> yes
</code></pre></div><p>nginxの構築に使用したモジュールの一覧は以下になります。</p> <table><thead><tr><th style="text-align:center;">モジュール名</th> <th style="text-align:left;">説明</th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/yum_module.html#yum-module" target="_blank" rel="noopener noreferrer">yum<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">yumコマンドを使ってRPMパッケージを操作できるモジュールです。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/yum_repository_module.html#yum-repository-module" target="_blank" rel="noopener noreferrer">yum-repository<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">yumで使用するリポジトリを操作できるモジュールです。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/file_module.html#file-module" target="_blank" rel="noopener noreferrer">file<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">対象サーバのファイルシステムを操作できるモジュールです。<br>ディレクトリやファイルを作成/削除したり、ファイルのオーナーやパーミッションを変更できたりします。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html#copy-module" target="_blank" rel="noopener noreferrer">copy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">対象サーバへファイルをコピーできるモジュールです。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/template_module.html#template-module" target="_blank" rel="noopener noreferrer">template<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;">対象サーバへファイルをコピーできるモジュールです。<code>copy</code>との違いはファイル内に<code>Jinja2</code>テンプレートが使える点です。<br>ファイル内で変数を使いたい場合はこちらを使います。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/systemd_module.html#systemd-module" target="_blank" rel="noopener noreferrer">systemd<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td style="text-align:left;"><a href="https://wiki.archlinux.jp/index.php/Systemd" target="_blank" rel="noopener noreferrer">systmed<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>によって管理されるプロセスを操作できるモジュールです。<br>基本的にはLinux環境でプロセスを常駐させる場合はこれを使います。</td></tr></tbody></table> <h4 id="roles-nginx-templates-etc-nginx-conf-d-app-conf-j2"><a href="#roles-nginx-templates-etc-nginx-conf-d-app-conf-j2" class="header-anchor">#</a> roles/nginx/templates/etc/nginx/conf.d/app.conf.j2</h4> <p>nginxの設定ファイルです。
ファイル内で変数を使用しているので<code>templates</code>下に配置しています。</p> <p>分かりやすさのために、配置するディレクトリをコピー先のパスと同じにしています。
Ansibleやサーバの構築/運用に慣れないうちは、こうしておくことをお勧めします。</p> <p>下記の内容を教材の<code>roles/nginx/templates/etc/nginx/conf.d/app.conf.j2</code>にコピーしましょう。</p> <div class="language-jinja extra-class"><pre class="language-text"><code>upstream app_backend {
    {% for app in nginx_backends %}
    server {{ app.host }}:{{ app.port }} max_fails=1 fail_timeout=3s;
    {% endfor %}
}

server {
  listen {{ nginx_https_port }} ssl;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_certificate /etc/nginx/ssl/server.crt;
  ssl_certificate_key /etc/nginx/ssl/server.key;
  ssl_dhparam /etc/nginx/ssl/dhparam.pem;

  location / {
    proxy_set_header  Host  $http_host;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-Host  $server_name;
    proxy_set_header  X-Forwarded-Server  $host;
    proxy_set_header  X-Forwarded-Proto  $scheme;
    proxy_set_header  X-Forwarded-Port {{ nginx_https_port }};
    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_pass  http://app_backend;
  }

  error_page 404 /404.html;

  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    root  /usr/share/nginx/html;
  }
}
</code></pre></div><p>nginxの設定について説明することは主題から外れるので、この講義では行いません。
興味のある人はnginxの<a href="http://nginx.org/en/docs/http/configuring_https_servers.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください。</p> <h4 id="playbooks-rp-yml"><a href="#playbooks-rp-yml" class="header-anchor">#</a> playbooks/rp.yml</h4> <p>nginxを構築するための実行ファイルです。
対象サーバとロールを指定することで、指定したサーバにnginxを構築できます。</p> <p>下記の内容を教材の<code>playbooks/rp.yml</code>にコピーしましょう。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> set up the reverse proxy server
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> rp
  <span class="token key atrule">become</span><span class="token punctuation">:</span> no
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ../vars/proxy.yml
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> roles/nginx
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> nginx
</code></pre></div><h4 id="site-yml"><a href="#site-yml" class="header-anchor">#</a> site.yml</h4> <p>最後に、さきほど作った<code>playbooks/rp.yml</code>をインポートする様に教材の<code>site.yml</code>に下記を追記します。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> playbooks/rp.yml
</code></pre></div><h3 id="実行"><a href="#実行" class="header-anchor">#</a> 実行</h3> <p>さて、ファイルがすべて準備できたらいよいよAnsibleを実行します。</p> <p>さきほど紹介したとおり、まずは<code>-C（--check）</code>オプションを付け、<code>dryrun</code>により結果を確認しましょう。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible-playbook -C site.yml
</code></pre></div><p><code>failed=0</code>の表示があれば実行は成功です。
<code>-C（--check）</code>オプションを外し、本実行を行いましょう。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible-playbook site.yml
</code></pre></div><p><code>failed=0</code>と表示されれば実行は成功です。</p> <p>ブラウザで<a href="https://localhost:8443" target="_blank" rel="noopener noreferrer">https://localhost:8443<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にアクセスして確認します。
自己証明書を使っているためブラウザから注意文言が表示されますが、スキップしてください。
すると、さきほどと同じ画面が表示されます。</p> <p>ここで、もう一つ注目してほしい部分があります。
Ansibleの実行ログを眺めると、データベースやJavaアプリケーションの構築用のタスクもステータスが<code>ok</code>の状態で、実行されているのが分かると思います。
またさきほど実行した<code>ansible-playbook site.yml</code>をもう一度実行すると、nginxの構築タスクも含め、すべてのタスクのステータスが<code>ok</code>になります。</p> <p>ある操作を何回行っても等価であるとき、その操作を<code>冪等</code>であると言います。
<strong>Ansibleの良さの1つがこの<code>冪等</code>性です。</strong>
基本的にAnsibleは同じタスクを何回実行しても、差分のないタスクは実行されません。
すなわち、ファイルを変更しない限りホストに対して余計な変更が加わらず、安全です。</p> <p>しかしこの<code>冪等</code>性は意識していないと壊れてしまう場合があります。
Ansibleを使うときは<code>冪等</code>性に注意を払いましょう。</p> <h2 id="_3-ケース2-バージョンアップ-スケーリング"><a href="#_3-ケース2-バージョンアップ-スケーリング" class="header-anchor">#</a> 3. [ケース2] バージョンアップ &amp; スケーリング</h2> <p>さて、nginxを導入して初期構築タスクを自動化できました。
次は変数やホスト情報を編集して、運用タスクを自動化してみましょう。</p> <h3 id="バージョンアップ"><a href="#バージョンアップ" class="header-anchor">#</a> バージョンアップ</h3> <p>まずはnginxのバージョンアップをしてみましょう。</p> <p>さきほどインストールされたnginxのバージョンは少し古めの<code>1.16.1</code>です。
このバージョンは<code>roles/nginx/defaults/main.yml</code>に<code>nginx_version</code>という変数として定義されています。
また、下記のコマンドを実行することで、確認することもできます。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible rp1 -m <span class="token builtin class-name">command</span> -a <span class="token string">'nginx -V'</span>
</code></pre></div><p>これを<code>1.18.0</code>にアップデートしてみたいと思います。
教材の<code>inventories/group_vars/all.yml</code>に下記を追記しましょう。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">nginx_version</span><span class="token punctuation">:</span> 1.18.0
</code></pre></div><p>Ansibleには変数の優先度が設定されており、同じ名前の変数は優先度の高いほうが有効になります。
これを利用することでロールの完全性を担保しつつ、タスクの内容を編集できます。</p> <p>具体的な優先度は<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください。</p> <p>ファイルの準備ができたらAnsibleを実行します。
さきほどと同様に<code>ansible-playbook -C site.yml</code>を実行しても良いですが、
実行したいのはnginxのタスクだけですので、データベースやアプリケーションのタスクは余計です。</p> <p>そこで実行コマンドを下記に変更します。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible-playbook -C site.yml -t nginx
</code></pre></div><p>すると、さきほどまで実行されていたデータベースやアプリケーション構築のタスクは実行されず、nginxの構築タスクだけが実行されます。
また<code>changed=1</code>となり、nginxのインストールのタスクだけが変更されることが確認できます。</p> <p>Ansibleにはタグという機能があり、タスクやロールなどに任意の値を設定できます。
これを利用することで、Ansible実行時に任意のタスクのみを実行する/しないことができます。
実はさきほどの<code>playbooks/rp.yml</code>にタグが設定してありました。</p> <p>タグは増やしすぎても管理がたいへんになるので、ある程度のまとまりやよく使うタスクにのみ付与するのが良いでしょう。
タグの詳細については<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください。</p> <p><code>failed=0</code>という表示が確認できたら<code>-C（--check）</code>のオプションを外し、上記コマンドを実行しましょう。</p> <p>本実行が完了したら、さきほどの確認コマンドを実行してバージョンが上がったことを確認してみましょう。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible rp1 -m <span class="token builtin class-name">command</span> -a <span class="token string">'nginx -V'</span>
</code></pre></div><h3 id="スケールアップ"><a href="#スケールアップ" class="header-anchor">#</a> スケールアップ</h3> <p>次はアプリケーションサーバをスケールアップ（増設）してみましょう。
と言っても増設用のサーバはすでにコンテナとして起動してあるので、皆さんがすべきことは下記2つのファイルの編集です。</p> <h4 id="inventories-hosts"><a href="#inventories-hosts" class="header-anchor">#</a> inventories/hosts</h4> <p>まずはAnsibleの管理対象にアプリケーション増設用のサーバ（app2）を追加します。
教材の<code>inventories/host</code>を下記のように追記してください。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>[app]
app1
<span class="token inserted-sign inserted">+ app2
</span></code></pre></div><p>これで<code>app</code>グループの中に<code>app2</code>サーバを追加できました。</p> <p>Ansibleには管理対象のホストをグルーピングし、設定したグループ単位でAnsibleを実行したり、変数を設定できたりします。
こうすることで、柔軟かつ効率的にサーバを管理できます。
この講義ではそれぞれ1台しかありませんが、データベースサーバやリバースプロキシサーバもグループに分けられています。</p> <p>Ansibleのグループやホストについての詳細は<a href="/bootcamp/ansible/hhttps:/docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups">公式ドキュメント</a>をご覧ください。</p> <h4 id="inventories-group-vars-all-yml"><a href="#inventories-group-vars-all-yml" class="header-anchor">#</a> inventories/group_vars/all.yml</h4> <p>次に変数ファイルを編集します。
さきほども編集した<code>inventories/group_vars/all.yml</code>に下記のように追記します。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>nginx_backends:
<span class="token unchanged">  - host: 192.0.2.12
    port: &quot;{{ server_port }}&quot;
</span><span class="token inserted-sign inserted">+ - host: 192.0.2.13
+   port: &quot;{{ server_port }}&quot;
</span></code></pre></div><p>これはnginxが通信を経由させるサーバのリストを格納している変数です。
ここに新しく<code>app2</code>サーバの情報を追記することで、nginxが<code>app2</code>サーバにも通信を流してくれます。</p> <p>nginxはロードバランサ（負荷分散装置）としての機能も備えているので、
こうすることで今まで<code>app1</code>サーバにしかいかなかった通信が<code>app2</code>にも行くようになり、負荷を分散できます。</p> <p>nginxの機能について詳しく説明することは主題から外れてしまいますので、この講義では行いません。
さらに詳しく知りたい人はnginxの<a href="http://nginx.org/en/docs/http/load_balancing.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください。</p> <h4 id="実行-2"><a href="#実行-2" class="header-anchor">#</a> 実行</h4> <p>さて、ファイルの準備ができたらAnsibleを実行します。
もうお馴染みとなった下記コマンドを実行します。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ansible-playbook -C site.yml
</code></pre></div><p><code>dryrun</code>で結果を確認すると、新たに<code>app2</code>サーバが増えていることが確認できます。
また、nginxの設定ファイルの差分も確認できるはずです。</p> <p><code>failed=0</code>と表示されていれば問題ありません。
<code>-C（--check）</code>のオプションを外し、本実行を行いましょう。</p> <p>コマンドが終了したら、ブラウザで<a href="https://localhost:8443" target="_blank" rel="noopener noreferrer">https://localhost:8443<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にアクセスして確認してみましょう。</p> <p>このWebアプリケーションは動作しているサーバのホスト名を画面に表示しています。
新しくブラウザを開き<a href="https://localhost:8443" target="_blank" rel="noopener noreferrer">https://localhost:8443<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にアクセスすると、ホスト名の表記が変わっているはずです。</p> <p>これにより、nginxが正常に負荷を分散してくれていることが確認できます。</p> <p>ここで、もう一つ注目していただきたいところがあります。
Ansibleの実行ログの中に、<code>RUNNING HANDLER</code>という表記が確認できると思います。
さきほどと同じ様に<code>ansible-playbook site.yml</code>と実行した場合、この表記がなくなると思います。</p> <p>これはAnsibleのハンドラという機能になります。
これは、ハンドラを設定したタスクが<code>changed</code>のときにのみ実行されるタスクを設定できる機能です。
実際に実行されるタスクは各ロールの<code>handlers/main.yml</code>に書かれています。</p> <p>これにより設定ファイルが変更された場合のみ、アプリケーションやデータベースなどのプロセスを再起動できます。
影響範囲を限定できるため、安全にホストに対して変更を加えることができます。</p> <p>詳細は<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#handlers-running-operations-on-change" target="_blank" rel="noopener noreferrer">公式ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください。</p> <h2 id="_4-応用課題-aclの導入"><a href="#_4-応用課題-aclの導入" class="header-anchor">#</a> 4. [応用課題] ACLの導入</h2> <p>応用課題として、全サーバにACL（Access Control List）を導入してみましょう。</p> <p>ACLとは、通信の（不）許可を設定することで、サーバのセキュリティレベルを高める手法のひとつです。
多くのプロダクション環境のサーバではACLが設定され、セキュリティレベルを高めています。</p> <p>この講義で使用したサーバのここまでの状態は、どんな通信でも許可してしまうセキュリティ的には脆弱な状態です（ローカル環境ですので攻撃されたりすることはありません）。</p> <p>そこで、ACLの実装のひとつである<a href="https://linuxjm.osdn.jp/html/iptables/man8/iptables.8.html" target="_blank" rel="noopener noreferrer">iptables<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を導入し、サーバのセキュリティレベルを向上させましょう。</p> <p>教材の<code>roles/iptables</code>にロールのひな型を用意しておきました。
このひな型を利用/編集して、全サーバにACLを導入できる様にしてみましょう。</p> <p>また、以下の表の通りに各サーバのポートを許可しましょう。
適切にポートを許可しなかった場合、Web画面が正常に表示されなくなります。</p> <table><thead><tr><th style="text-align:center;">サーバ名</th> <th style="text-align:center;">グループ名</th> <th style="text-align:center;">許可ポート</th></tr></thead> <tbody><tr><td style="text-align:center;">db1</td> <td style="text-align:center;">db</td> <td style="text-align:center;">3306</td></tr> <tr><td style="text-align:center;">app[1,2]</td> <td style="text-align:center;">app</td> <td style="text-align:center;">8080</td></tr> <tr><td style="text-align:center;">rp1</td> <td style="text-align:center;">rp</td> <td style="text-align:center;">8443</td></tr></tbody></table> <h3 id="ヒント"><a href="#ヒント" class="header-anchor">#</a> ヒント</h3> <p>いくつかヒントを載せておきます。</p> <ol><li>CentOS7で<code>iptables</code>をインストールする場合は<code>yum</code>で<code>iptables-services</code>をインストールする</li> <li>設定ファイルは<code>/etc/sysconfig/iptables</code></li> <li>Ansibleのすべての管理対象サーバは<code>all</code>グループに自動的に属している</li> <li>各グループの変数は<code>inventories/group_vars/&lt;group_name&gt;.yml</code>で設定できる</li> <li>まずは<code>roles/iptables</code>の中身を確認してみるとよいでしょう</li></ol> <h3 id="解答例"><a href="#解答例" class="header-anchor">#</a> 解答例</h3> <p><a href="https://github.com/iij/ansible-exercise/tree/solution" target="_blank" rel="noopener noreferrer">教材のsolutionブランチ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>が解答例になっています。
この解答例以外にも多くの実現方法がありますが、参考にしてもらえればと思います。</p> <p>他のファイルについても、この講義を受けた後の最終的なファイルの内容になっています。
ハンズオンを進める中でつまずくことがあれば、参考にしてもらえればと思います。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/ansible/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/20/2020, 4:13:06 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.b03fadc6.js" defer></script><script src="/bootcamp/assets/js/2.b1640ebb.js" defer></script><script src="/bootcamp/assets/js/12.a47c18a6.js" defer></script>
  </body>
</html>
