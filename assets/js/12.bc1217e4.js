(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{402:function(t,s,a){t.exports=a.p+"assets/img/apache-start.c57e81f7.png"},403:function(t,s,a){t.exports=a.p+"assets/img/site-80.7a41e96d.png"},404:function(t,s,a){t.exports=a.p+"assets/img/site-81.19ee5e97.png"},405:function(t,s,a){t.exports=a.p+"assets/img/nginx_html.ac55e229.png"},406:function(t,s,a){t.exports=a.p+"assets/img/nginx-proxy.drawio.50845ff4.png"},464:function(t,s,a){"use strict";a.r(s);var e=a(10),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"apache-nginx-を触ってみよう"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-nginx-を触ってみよう"}},[t._v("#")]),t._v(" Apache + Nginx を触ってみよう")]),t._v(" "),s("h2",{attrs:{id:"事前準備"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事前準備"}},[t._v("#")]),t._v(" 事前準備")]),t._v(" "),s("p",[t._v("以下のように"),s("code",[t._v("docker pull")]),t._v("をしたあと、ハンズオン用のコンテナを立ち上げてログインしてください。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull python:3.8.2-buster")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("3.8.2-buster: Pulling from library/python\n90fe46dd8199: Pull complete\n35a4f1977689: Pull complete\nbbc37f14aded: Pull complete\n74e27dc593d4: Pull complete\n4352dcff7819: Pull complete\ndeb569b08de6: Pull complete\n98fd06fa8c53: Pull complete\n7b9cc4fdefe6: Pull complete\n512732f32795: Pull complete\nDigest: sha256:003990f08716aef3eb0772f9d9fa8e27603f2b863c56c649a3e9693ddb5b41f1\nStatus: Downloaded newer image for python:3.8.2-buster\ndocker.io/library/python:3.8.2-buster\n")]),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run --rm -itd --name test-debian -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":80 -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8081")]),t._v(":81 -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8088")]),t._v(":88 -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8089")]),t._v(":89 -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),t._v(":443 -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8444")]),t._v(":444 python:3.8.2-buster /bin/bash")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("b8c0df20d1540aba0342362d88d1b0cb9ec94a1877ae1ca5aea5583880193a8e\n")]),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it test-debian /bin/bash")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("root@b8c0df20d154:/#\n")])])])]),s("p",[t._v("Apacheとnginxをインストールします。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token info punctuation"}},[s("span",{pre:!0,attrs:{class:"token user"}},[t._v("root@b8c0df20d154")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token path"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("#")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" update")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("Get:1 http://security.debian.org/debian-security buster/updates InRelease [65.4 kB] \nGet:2 http://deb.debian.org/debian buster InRelease [121 kB]                        \nGet:3 http://deb.debian.org/debian buster-updates InRelease [51.9 kB]\nGet:4 http://security.debian.org/debian-security buster/updates/main amd64 Packages [289 kB]\nGet:5 http://deb.debian.org/debian buster/main amd64 Packages [7907 kB]\nGet:6 http://deb.debian.org/debian buster-updates/main amd64 Packages [10.9 kB]\nFetched 8445 kB in 18s (471 kB/s)\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\n103 packages can be upgraded. Run 'apt list --upgradable' to see them.\n\n")]),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token info punctuation"}},[s("span",{pre:!0,attrs:{class:"token user"}},[t._v("root@b8c0df20d154")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token path"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("#")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -y apache2 apache2-dev nginx "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")])])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("Reading package lists... Done\nBuilding dependency tree\nReading state information... Done\nThe following additional packages will be installed:\n  apache2-bin apache2-data apache2-utils autopoint bsdmainutils debhelper dh-autoreconf dh-strip-nondeterminism dwz geoip-database gettext gettext-base\n  groff-base intltool-debian libapr1-dev libaprutil1-dbd-sqlite3 libaprutil1-dev libaprutil1-ldap libarchive-cpio-perl libarchive-zip-perl libbrotli1\n  libfile-stripnondeterminism-perl libgd3 libgeoip1 libgpm2 libjansson4 libldap-2.4-2 libldap2-dev liblua5.2-0 \n\n~~~略~~~\n\nSetting up dh-strip-nondeterminism (1.1.2-1) ...\nSetting up apache2-dev (2.4.38-3+deb10u4) ...\nProcessing triggers for mime-support (3.62) ...\nProcessing triggers for hicolor-icon-theme (0.17-2) ...\nProcessing triggers for libc-bin (2.28-10) ...\nroot@b8c0df20d154:/#\n")])])])]),s("p",[t._v("以下のコマンドでバージョンが表示されれば成功です。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token info punctuation"}},[s("span",{pre:!0,attrs:{class:"token user"}},[t._v("root@b8c0df20d154")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token path"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("#")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t._v("apache2 -v")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("Server version: Apache/2.4.38 (Debian)\nServer built:   2021-12-21T16:50:43\n\n")]),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token info punctuation"}},[s("span",{pre:!0,attrs:{class:"token user"}},[t._v("root@b8c0df20d154")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token path"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("#")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t._v("nginx -v")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("nginx version: nginx/1.14.2\n")])])])]),s("h2",{attrs:{id:"webサーバー"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#webサーバー"}},[t._v("#")]),t._v(" Webサーバー")]),t._v(" "),s("p",[t._v("いわゆる「Webサーバー」とは、HTTP(Hypertext Transfer Protocol)でリクエストを受け、HTTPでレスポンスを返すソフトウェアの通称です。\n僕らがブラウザなどにURLを入力したりリンクをクリックした時、Webページが表示されるのはWebサーバーが要求したURLに対するレスポンスを返しているからです。またスマホアプリの裏で行われるサーバーとのやりとりには多くの場合HTTPが使われており、ここでもWebサーバーがゲームのデータなどをレスポンスとして返しています。")]),t._v(" "),s("p",[t._v("Webサーバのシンプルな機能は前述の通りですが、実際にはユースケースに合わせてさまざまな役割を持ちます。")]),t._v(" "),s("ul",[s("li",[t._v("HTMLやテキストファイルの配信")]),t._v(" "),s("li",[t._v("動的アプリケーションのホスティング\n"),s("ul",[s("li",[t._v("JavaやPythonやPHPなど、プログラムで生成されたレスポンスを返す")])])]),t._v(" "),s("li",[t._v("HTTP通信を別のサーバーに中継するプロキシ")]),t._v(" "),s("li",[t._v("Basic認証などによる認証処理")]),t._v(" "),s("li",[t._v("ACL(Access Control List)によるアクセス制御・不正な通信への防御")])]),t._v(" "),s("p",[t._v("簡単なWebサーバーであればどのプログラミング言語でも比較的簡単に作ることができます。\nしかし実用上はさまざまな機能をもち、セキュリティやパフォーマンスについても長年改善されてきた専用のソフトウェアが必要になり、それがいわゆる「Webサーバーソフトウェア」と呼ばれるツールです。")]),t._v(" "),s("p",[t._v("有名どころを挙げてみると")]),t._v(" "),s("ul",[s("li",[t._v("Apache HTTP Server")]),t._v(" "),s("li",[t._v("IIS")]),t._v(" "),s("li",[t._v("lighttpd")]),t._v(" "),s("li",[t._v("nginx")])]),t._v(" "),s("p",[t._v("あたりでしょうか。Linuxサーバー上で動かすのであればほぼApacheとnginxの2択になると思います。")]),t._v(" "),s("p",[t._v("また最近ではenvoyやtraefikなど、クラウドやKubernetesという文脈ではプロキシ機能に特化したソフトウェアが使われることも多くなりました。")]),t._v(" "),s("h2",{attrs:{id:"apache-と-nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-と-nginx"}},[t._v("#")]),t._v(" Apache と Nginx")]),t._v(" "),s("h3",{attrs:{id:"apache-http-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-http-server"}},[t._v("#")]),t._v(" Apache HTTP Server")]),t._v(" "),s("p",[t._v("「Apache HTTP Server」はnginxと並んで2大勢力を誇っているWebサーバソフトウェアのひとつです。 CentOSではhttpdという名前になっていたり、単にApacheと呼ばれます。")]),t._v(" "),s("p",[t._v("「Apache HTTP Server」は「Apacheソフトウェア財団」によって管理されるOSSで、20年以上の歴史を持ちます。 世界的にもっとも普及したWebサーバで、LAMP（Linux, Apache, MySQL, PHP）環境のひとつにも挙げられ、nginxと並んで2大勢力を誇ります。\n(参考: "),s("a",{attrs:{href:"https://news.netcraft.com/archives/2022/06/30/june-2022-web-server-survey.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("June 2022 Web Server Survey"),s("OutboundLink")],1),t._v(")")]),t._v(" "),s("p",[t._v("正式名称は「Apache HTTP Server」ですが、歴史的経緯などからCentOSではhttpdという名前になっていたり、単にApacheと呼ばれたりします。")]),t._v(" "),s("p",[t._v("以前は大量のリクエストを受けた際にプロセスをforkできず、リクエストを捌き切れなくなる（いわゆるC10K問題）ことが問題視されました。 その際nginxをはじめとして新しいWebサーバーソフトウェアが登場しましたが、Apache自体もworkerやevent MPMといった新しい仕組みを導入し、動作も安定していることからいまだに高いシェアを占めています。")]),t._v(" "),s("h3",{attrs:{id:"nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[t._v("#")]),t._v(" nginx")]),t._v(" "),s("p",[t._v("nginxは2004年頃、当時のWebサーバーが抱えていたパフォーマンス問題(C10K問題)の解決を背景に開発が進められました。\n当時からApache 2.2は高機能で信頼性が高く、ある種成熟したソフトウェアでしたが、それに対してnginxは軽量さと高パフォーマンスに焦点をあてて開発されており、Apacheのカバーしきれないユースケースに対して力を発揮しました。")]),t._v(" "),s("p",[t._v("特に後段のサーバーにリクエストを流すリバースプロキシ・ロードバランサ機能がとても使いやすく、どちらかというと軽量なリクエストを大量に捌くのに向いています。")]),t._v(" "),s("h2",{attrs:{id:"apache-ハンズオン"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-ハンズオン"}},[t._v("#")]),t._v(" Apache ハンズオン")]),t._v(" "),s("h3",{attrs:{id:"htmlファイルの配信-check1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#htmlファイルの配信-check1"}},[t._v("#")]),t._v(" HTMLファイルの配信(check1)")]),t._v(" "),s("p",[t._v("まずはApacheを起動しましょう。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" apache2 start")])]),t._v("\n")])])]),s("p",[t._v("ブラウザを開いて"),s("a",{attrs:{href:"http://localhost:8080",target:"_blank",rel:"noopener noreferrer"}},[t._v("localhost:8080"),s("OutboundLink")],1),t._v("にアクセスしてみてください。以下のような画面が表示されれば成功です。")]),t._v(" "),s("p",[s("img",{attrs:{src:a(402),alt:"apache-start"}})]),t._v(" "),s("p",[t._v("表示されたページはデフォルトのHTMLファイルです。これを自分で作成したページに置き換えてみましょう。 デフォルトではDocument Rootは/var/www/html/に設定されています。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("Document RootはApacheが静的ファイルを配信するためのroot directoryです。")])]),t._v(" "),s("p",[t._v("この下にある"),s("code",[t._v("index.html")]),t._v("ファイルを自分の物に置き換えてみましょう。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /var/www/html/")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" index.html _index.html")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Hello Bootcamp!!'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" index.html")])]),t._v("\n")])])]),s("p",[t._v("再び"),s("code",[t._v("http://localhost:8080/")]),t._v("を開くと"),s("code",[t._v("Hello Bootcamp!!")]),t._v("が表示されるのを確認してください。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[s("code",[t._v("http://localhost:8080/")]),t._v(" のようにファイル名を指定せずディレクトリ（この場合はルートディレクトリ）を指定した場合、Apacheは"),s("code",[t._v("index.html")]),t._v("を返すようにデフォルトで設定されています。\nこの設定は変更できます。")])]),t._v(" "),s("p",[t._v("Document Root配下にディレクトリを作成するとブラウザからも同様にアクセスできます。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /var/www/html/hoge")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Hello HUGA!!'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /var/www/html/hoge/huga.txt")])]),t._v("\n")])])]),s("p",[s("code",[t._v("http://localhost:8080/hoge/huga.txt")]),t._v(" にアクセスすると追加したファイルが表示されます。")]),t._v(" "),s("p",[t._v("アクセスログも確認してみましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tail")]),t._v(" /var/log/apache2/access.log\n")])])]),s("h3",{attrs:{id:"virtualhost-の設定-check2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#virtualhost-の設定-check2"}},[t._v("#")]),t._v(" VirtualHost の設定(check2)")]),t._v(" "),s("p",[t._v("1つのApacheで複数のWebサイトを管理したいことがあります。異なるIPアドレスやアドレス、port番号からアクセスされた時にDocument Rootなどを切り替えたいときは"),s("code",[t._v("VirtualHost")]),t._v("を設定することで実現できます。")]),t._v(" "),s("p",[t._v("ここではport番号を"),s("code",[t._v("80")]),t._v("と"),s("code",[t._v("81")]),t._v("に分けて別々のWebサイトを設定してみます。\n(docker起動時にport forwardしているため、手元からは"),s("code",[t._v("8080")]),t._v("と"),s("code",[t._v("8081")]),t._v("からアクセスできます。)")]),t._v(" "),s("p",[t._v("まずは新しくDocument RootになるディレクトリとHTMLファイルを作成します。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /var/www/html/site-80\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /var/www/html/site-81\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'This is site 80!'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /var/www/html/site-80/index.html\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'This is site 81!'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /var/www/html/site-81/index.html\n")])])]),s("p",[t._v("次にApacheの設定をして行きます。やることは")]),t._v(" "),s("ul",[s("li",[t._v("listen portに81を追加")]),t._v(" "),s("li",[t._v("virtual host設定の追加")])]),t._v(" "),s("p",[t._v("の2つです。listen portの追加は"),s("code",[t._v("/etc/apache2/ports.conf")]),t._v("に書きましょう。\n以下のように"),s("code",[t._v("Listen 80")]),t._v(" の下に "),s("code",[t._v("Listen 81")]),t._v("の記述を追加します。")]),t._v(" "),s("div",{staticClass:"language-apache extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# If you just change the port or add more ports here, you will likely also\n# have to change the VirtualHost statement in\n# /etc/apache2/sites-enabled/000-default.conf\n\nListen 80\nListen 81\n\n<IfModule ssl_module>\n        Listen 443\n</IfModule>\n\n<IfModule mod_gnutls.c>\n        Listen 443\n</IfModule>\n\n# vim: syntax=apache ts=4 sw=4 sts=4 sr noet\n")])])]),s("p",[t._v("VitrualHostの設定は"),s("code",[t._v("/etc/apache2/sites-available")]),t._v("の下に作成して行きます。")]),t._v(" "),s("p",[s("code",[t._v("/etc/apache2/sites-available/site-80.conf")])]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("VirtualHost")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("*:")]),t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  DocumentRoot /var/www/html/site-80\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("VirtualHost")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[s("code",[t._v("/etc/apache2/sites-available/site-81.conf")])]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("VirtualHost")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("*:")]),t._v("81")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  DocumentRoot /var/www/html/site-81\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("VirtualHost")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("設定ファイルを作成したら"),s("code",[t._v("a2dissite")]),t._v("、"),s("code",[t._v("a2ensite")]),t._v("コマンドを使って設定を有効化しましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("a2dissite 000-default\na2ensite site-80\na2ensite site-81\n")])])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[s("code",[t._v("a2dissite")]),t._v("や"),s("code",[t._v("a2ensite")]),t._v("といったコマンドは実はapache本体の機能ではありません。"),s("code",[t._v("a2ensite")]),t._v("は"),s("code",[t._v("/etc/apache2/sites-available")]),t._v("以下のファイルのsymlinkを"),s("code",[t._v("/etc/apache2/sites-enable")]),t._v("以下に追加するだけのコマンドです。\n実際のApacheは"),s("code",[t._v("/etc/apache2/sites-enable")]),t._v("以下のコンフィグファイルをloadしているため、コマンドによってサイトが有効化されたように見えるのです。")]),t._v(" "),s("p",[t._v("CentOSなど他のディストリビューションでは、これらのコマンドが存在しないことが多いので注意してください。")])]),t._v(" "),s("p",[t._v("そしてApacheをリスタートします。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" apache2 reload\n")])])]),s("p",[s("code",[t._v("localhost:8080")]),t._v("と"),s("code",[t._v("localhost:8081")]),t._v("にアクセスしてみてください。意図通りの挙動になっているでしょうか。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("img",{attrs:{src:a(403),alt:"site-80"}})])])]),t._v(" "),s("tbody")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("img",{attrs:{src:a(404),alt:"site-81"}})])])]),t._v(" "),s("tbody")]),t._v(" "),s("h2",{attrs:{id:"nginx-ハンズオン"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-ハンズオン"}},[t._v("#")]),t._v(" nginx ハンズオン")]),t._v(" "),s("h3",{attrs:{id:"htmlファイルの配信-check3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#htmlファイルの配信-check3"}},[t._v("#")]),t._v(" HTMLファイルの配信(check3)")]),t._v(" "),s("p",[t._v("次はnginxを使って同じことをしてみましょう。")]),t._v(" "),s("p",[t._v("80 portはすでにApacheが使っているため、nginxのサイトは88 portでリクエストを受け付けるようにします。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/nginx/sites-enabled/default\n")])])]),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("88")]),t._v(" default_server")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 80 => 88 に変更")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" [::]:88 default_server")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 80 => 88 に変更")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /var/www/html")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" index.html index.htm index.nginx-debian.html")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" _")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try_files")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$uri")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$uri")]),t._v("/ =404")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("変更したらnginxを起動しましょう。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token info punctuation"}},[s("span",{pre:!0,attrs:{class:"token user"}},[t._v("root@6adf6c41f5d8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token path"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("#")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" nginx start")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("[ ok ] Starting nginx: nginx.\n")])])])]),s("p",[s("a",{attrs:{href:"http://localhost:8088",target:"_blank",rel:"noopener noreferrer"}},[t._v("localhost:8088"),s("OutboundLink")],1),t._v(" にアクセスしてみてください。さっき作った"),s("code",[t._v("Hello Bootcamp!!")]),t._v("のHTMLが見えていれば成功です。")]),t._v(" "),s("p",[s("img",{attrs:{src:a(405),alt:"nginx_html"}})]),t._v(" "),s("p",[t._v("アクセスログも確認してみましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tail")]),t._v(" /var/log/nginx/access.log\n")])])]),s("h3",{attrs:{id:"ロードバランス-check4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ロードバランス-check4"}},[t._v("#")]),t._v(" ロードバランス(check4)")]),t._v(" "),s("p",[t._v("nginxのプロキシ・ロードバランス機能を使ってみましょう。以下のような構成を作ってみます。")]),t._v(" "),s("p",[s("img",{attrs:{src:a(406),alt:"nginx_proxy"}})]),t._v(" "),s("p",[s("code",[t._v("localhost:8089")]),t._v("にアクセスすると、先ほどApacheで作ったsite-80とsite-89のどちらかにランダムでリクエストをプロキシするようにします。")]),t._v(" "),s("p",[t._v("そのための設定を"),s("code",[t._v("/etc/nginx/sites-enabled/proxy")]),t._v("に書いていきます。")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" backend")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" localhost:80 weight=1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" localhost:81 weight=1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("89")]),t._v(" default_server")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" [::]:89 default_server")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v(" index.html index.htm index.nginx-debian.html")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" _")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" http://backend")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("code",[t._v("/etc/nginx/sites-enabled/proxy")]),t._v("を作成したらnginxをリスタートしましょう。")]),t._v(" "),s("div",{staticClass:"language-shell-session extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell-session"}},[s("code",[s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token info punctuation"}},[s("span",{pre:!0,attrs:{class:"token user"}},[t._v("root@dea1ac0e1edb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token path"}},[t._v("/var/www/html")])]),s("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[t._v("#")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" nginx restart")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token output"}},[t._v("[ ok ] Restarting nginx: nginx.\n")])])])]),s("p",[s("a",{attrs:{href:"http://localhost:8089/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:8089/"),s("OutboundLink")],1),t._v(" にアクセスしてみてください。\nsite-80とsite-81がランダムで表示されたでしょうか。")]),t._v(" "),s("h3",{attrs:{id:"https-対応-check5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#https-対応-check5"}},[t._v("#")]),t._v(" https 対応(check5)")]),t._v(" "),s("p",[t._v("HTTP は基本的に平文でデータをやりとりします。")]),t._v(" "),s("p",[t._v("ということは、途中でパケットキャプチャをすると、やり取りの内容を読み取ることができます。")]),t._v(" "),s("p",[t._v("もしそこにパスワード情報など見られてはいけない情報が含まれていたら...怖いですね。")]),t._v(" "),s("p",[t._v("そこで、SSL/TLS (Secure Socket Layer/Transport Layer Securityの技術)を用いて通信路の暗号化を行うHTTP over SSL いわゆるHTTPS を重要な情報のやりとりを行う際には用いるのが一般的です。")]),t._v(" "),s("p",[t._v("各種Web サーバはこのHTTPS もサポートしており、証明書とそれに対応する秘密鍵さえあれば、簡単に設定することができます。")]),t._v(" "),s("h4",{attrs:{id:"証明書と秘密鍵の用意"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#証明書と秘密鍵の用意"}},[t._v("#")]),t._v(" 証明書と秘密鍵の用意")]),t._v(" "),s("p",[t._v("HTTPS で用いる証明書は、権威ある証明局から、これは正当な証明書である、とお墨付きをもらうことで正当性が担保されています。")]),t._v(" "),s("p",[t._v("通常、証明書は以下の手順で入手します。")]),t._v(" "),s("ol",[s("li",[t._v("秘密鍵を生成する")]),t._v(" "),s("li",[t._v("秘密鍵からCSR (Certificate Signing Request) を生成する")]),t._v(" "),s("li",[t._v("CSR を証明書に提出し、審査を受け、証明局の持つ秘密鍵で署名された証明書を発行してもらう")])]),t._v(" "),s("p",[t._v("ここでは、３を簡略化して1 で生成した鍵で署名する、自己署名証明書(いわゆるオレオレ証明書)を作ります。\nこのdocker image に既にインストールされている、openssl ツールで一通りの操作を行うことができます。")]),t._v(" "),s("h5",{attrs:{id:"_1-秘密鍵を生成する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-秘密鍵を生成する"}},[t._v("#")]),t._v(" 1. 秘密鍵を生成する")]),t._v(" "),s("p",[t._v("ここではRSA の2048 bit の秘密鍵を生成します。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("サブコマンドであるgenrsa はRSA 暗号の秘密鍵を生成するものとなります。")])]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("root@b8c0df20d154:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# openssl genrsa 2048 > private.key")]),t._v("\nGenerating RSA private key, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v(" bit long modulus "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" primes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("+++++\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".+++++\ne is "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65537")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0x010001"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h5",{attrs:{id:"_2-秘密鍵からcsr-certificate-signing-request-を生成する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-秘密鍵からcsr-certificate-signing-request-を生成する"}},[t._v("#")]),t._v(" 2. 秘密鍵からCSR (Certificate Signing Request) を生成する")]),t._v(" "),s("p",[t._v("1 で作った秘密鍵から、CSR を生成します。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("サブコマンドであるreq はCSR を扱うためのものとなります。")])]),t._v(" "),s("p",[t._v("証明書で表示する情報をここで入力することになります。\n実際に発行する際は、正当性を担保したい対象であるCommon Name は特に間違わないようにしましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("root@b8c0df20d154:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# openssl req -new -sha256 -key private.key -out server.csr")]),t._v("\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.'")]),t._v(", the field will be left blank.\n-----\nCountry Name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" letter code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("AU"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":JP\nState or Province Name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("full name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Some-State"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":Tokyo\nLocality Name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg, city"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":Chiyoda\nOrganization Name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg, company"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Internet Widgits Pty Ltd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":IIJ\nOrganizational Unit Name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg, section"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":TU\nCommon Name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e.g. server FQDN or YOUR name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":localhost\nEmail Address "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":\n\nPlease enter the following "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'extra'")]),t._v(" attributes\nto be sent with your certificate request\nA challenge password "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":\nAn optional company name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":\n")])])]),s("h5",{attrs:{id:"_3-署名された証明書を発行する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-署名された証明書を発行する"}},[t._v("#")]),t._v(" 3. 署名された証明書を発行する")]),t._v(" "),s("p",[t._v("1 で作った秘密鍵、2 で作ったCSR から証明書を発行します。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("サブコマンドであるx509 は、証明書の標準規格を指しています。\n-req でinput がCSR であることを示し、signkey に1 で作った秘密鍵を指定することでこれで署名します。")])]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("root@b8c0df20d154:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# openssl x509 -req -in server.csr -out server.crt -signkey private.key -days 365")]),t._v("\nSignature ok\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("subject")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("C "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" JP, ST "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Tokyo, L "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Chiyoda, O "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" IIJ, OU "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TU, CN "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" localhost\nGetting Private key\n")])])]),s("p",[t._v("出来上がったら、証明書の中を覗いてみましょう。text オプションでテキスト出力をすることができます。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("root@b8c0df20d154:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# openssl x509 -in server.crt -text")]),t._v("\nCertificate:\n    Data:\n        Version: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0x0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        Serial Number:\n            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("45")]),t._v(":ef:45:48:8c:89:e0:e5:38:74:f7:fc:21:32:35:eb:2b:bc:10:6b\n        Signature Algorithm: sha256WithRSAEncryption\n        Issuer: C "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" JP, ST "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Tokyo, L "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Chiyoda, O "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" IIJ, OU "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TU, CN "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" localhost\n        Validity\n            Not Before: Aug  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":29:36 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v(" GMT\n            Not After "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" Aug  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":29:36 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2023")]),t._v(" GMT\n        Subject: C "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" JP, ST "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Tokyo, L "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Chiyoda, O "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" IIJ, OU "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TU, CN "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" localhost\n        Subject Public Key Info:\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".省略"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("実際に発行されたものを確認する際は、期間(Not BeforeとNot After)とSubject (CN が正しいか)に特に注意しましょう。")]),t._v(" "),s("p",[t._v("秘密鍵と証明書のペアが正しいかを確認するには、RSA のものならmodulus を比較するのが簡単です。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("root@b8c0df20d154:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# openssl rsa -in private.key -modulus -noout")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Modulus")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("FB1908BE2B1567D1B8B7EE99DF3480CE2EDF57EC73ADD08AE2FA37A833321C84CF49D6D3F8011419BDAF8882B6E610C097D7016D173A14B7343E8D1381B8CF7FCD14CAA5717594B6F5CD586BF13EB90D2673E03B73EB25463333BD8D4384477C7910E87C8CEB2E71C83E59DD3BAC61E9B19DB97545AA9DB96DC995B01B2F96FA62CD8C777C0DA3A0377F71E0F6251CE7511964F2B4604D7F88472759C0178ECA1C7B21F9D9198166F28097A6EDF76925247119B7BEBDA73DD387607BD6320444E0242E127108C234B7F0D6CD6EB7E496747BDE7249E606BA44024E1FCC61E9ADBBE1BDABE51B342AF7DA5801AE36393E11EFFFAE60047EA7FE1E8E9A12FFF57B\n\nroot@b8c0df20d154:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# openssl x509 -in server.crt -modulus -noout")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Modulus")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("FB1908BE2B1567D1B8B7EE99DF3480CE2EDF57EC73ADD08AE2FA37A833321C84CF49D6D3F8011419BDAF8882B6E610C097D7016D173A14B7343E8D1381B8CF7FCD14CAA5717594B6F5CD586BF13EB90D2673E03B73EB25463333BD8D4384477C7910E87C8CEB2E71C83E59DD3BAC61E9B19DB97545AA9DB96DC995B01B2F96FA62CD8C777C0DA3A0377F71E0F6251CE7511964F2B4604D7F88472759C0178ECA1C7B21F9D9198166F28097A6EDF76925247119B7BEBDA73DD387607BD6320444E0242E127108C234B7F0D6CD6EB7E496747BDE7249E606BA44024E1FCC61E9ADBBE1BDABE51B342AF7DA5801AE36393E11EFFFAE60047EA7FE1E8E9A12FFF57B\n")])])]),s("h4",{attrs:{id:"https-の設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#https-の設定"}},[t._v("#")]),t._v(" https の設定")]),t._v(" "),s("p",[t._v("check4 で作ったhttp で受けていたproxy をhttps でも受けられるようにしてみます。")]),t._v(" "),s("p",[s("code",[t._v("/etc/nginx/sites-enabled/proxy")]),t._v(" の一番下に以下を追記していきます。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" default_server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        listen "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("::"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":443 default_server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        ssl on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        ssl_certificate /server.crt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        ssl_certificate_key /private.key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        index index.html index.htm index.nginx-debian.html"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        server_name _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                proxy_pass http://backend"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("追記したら、nginx をリスタートしましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("root@dea1ac0e1edb:/var/www/html"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# service nginx restart")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" ok "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Restarting nginx: nginx.\n")])])]),s("p",[t._v("443 は8443 にポートフォワードの設定が入っているため、8443 ポートにアクセスしてみましょう。\nhttps での通信となるため、URL の先頭がhttp ではなくhttps となっています。")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://localhost:8443/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://localhost:8443/"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("今回は自己署名証明書であるため、ほとんどのブラウザは正当な証明書ではないと判断し、注意喚起の画面が表示されます。\n危険性を承知で閲覧すると、Check4 の時と同様のものが表示されます。")]),t._v(" "),s("p",[t._v("また、ブラウザ上で暗号化に使っている証明書の内容が確認できるので、確認もしてみましょう。")]),t._v(" "),s("h2",{attrs:{id:"追加課題-時間の余った人用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#追加課題-時間の余った人用"}},[t._v("#")]),t._v(" 追加課題（時間の余った人用）")]),t._v(" "),s("h3",{attrs:{id:"apache-でもhttpsを設定してみよう"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apache-でもhttpsを設定してみよう"}},[t._v("#")]),t._v(" apache でもhttpsを設定してみよう")]),t._v(" "),s("ul",[s("li",[t._v("Apache でもhttps を受けられるようにしてみましょう。")]),t._v(" "),s("li",[t._v("8444 を444 にポートフォワードする設定も予め入れてあるので、444 で受ける設定を入れれば、外から8444 でアクセスできます。証明書は同じものを使い回しで構いません。")])]),t._v(" "),s("h3",{attrs:{id:"basic認証を追加してみよう"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#basic認証を追加してみよう"}},[t._v("#")]),t._v(" Basic認証を追加してみよう")]),t._v(" "),s("ul",[s("li",[t._v("ApacheとnginxそれぞれにBasic認証を導入し、アクセスした時にユーザー名とパスワードの入力を求められるようにしてください。")]),t._v(" "),s("li",[t._v("ブラウザで動作確認ができたら、次は"),s("code",[t._v("curl")]),t._v("コマンドでアクセスしてBasic認証がどのように動作するか確認してください。")])]),t._v(" "),s("h3",{attrs:{id:"pythonアプリを動かしてみよう"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pythonアプリを動かしてみよう"}},[t._v("#")]),t._v(" Pythonアプリを動かしてみよう")]),t._v(" "),s("p",[t._v("Pythonで書かれたWebアプリをApache経由で動かす設定を作ってみます。\nこのdocker imageには既にpythonがインストールされています。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("python --version\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Python 3.8.2")]),t._v("\n")])])]),s("p",[t._v("Pythonで作成したWebアプリをApacheなどから実行する場合、"),s("a",{attrs:{href:"https://ja.wikipedia.org/wiki/Web_Server_Gateway_Interface",target:"_blank",rel:"noopener noreferrer"}},[t._v("WSGI"),s("OutboundLink")],1),t._v("というインタフェース定義に従ってWebアプリを作成します。\nこれはPython側のインタフェースを規定することで、他のプログラム(今回の場合Apache)から呼び出しやすくする物です。")]),t._v(" "),s("p",[t._v("あとでやるDjangoなど主要なPythonフレームワークはこのAPIに従っているため、Djangoで作成したアプリは今回と同じ手順でApacheから実行することができます。")]),t._v(" "),s("p",[t._v("以下のようなPythonコードを"),s("code",[t._v("/var/www/html/site-80")]),t._v("以下に置いておきましょう。")]),t._v(" "),s("p",[s("code",[t._v("vim /var/www/html/site-80/app.py")])]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("application")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("environ"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start_response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    status "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'200 OK'")]),t._v("\n    output "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("b'Hello! This is python application!'")]),t._v("\n\n    response_headers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'text/plain'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Length'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("output"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    start_response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" response_headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("output"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("次にwsgiを動かすためのApache moduleをインストールします。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" mod-wsgi\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Collecting mod-wsgi")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  Using cached mod_wsgi-4.7.1.tar.gz (498 kB)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Building wheels for collected packages: mod-wsgi")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  Building wheel for mod-wsgi (setup.py) ... done")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  Created wheel for mod-wsgi: filename=mod_wsgi-4.7.1-cp38-cp38-linux_x86_64.whl size=809821 sha256=570b19e67813e819f04ee00006b5c556339e37a03dea4af0021837b098588c0d")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  Stored in directory: /root/.cache/pip/wheels/e9/82/71/1b42d6274a24af477453cecc993213fc8abd15433d80b01e93")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Successfully built mod-wsgi")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Installing collected packages: mod-wsgi")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Successfully installed mod-wsgi-4.7.1")]),t._v("\n")])])]),s("p",[t._v("インストールすると以下のディレクトリにsoファイルが生成されています。Apacheに読み込ませる必要があるため確認しておきましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" /usr/local/lib/python3.8/site-packages/mod_wsgi/server/mod_wsgi-py38.cpython-38-x86_64-linux-gnu.so\n")])])]),s("p",[t._v("このファイルを読み込むように、"),s("code",[t._v("vim /etc/apache2/mods-available/wsgi.load")]),t._v("を以下のように作成します。")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[t._v("LoadModule wsgi_module /usr/local/lib/python3.8/site-packages/mod_wsgi/server/mod_wsgi-py38.cpython-38-x86_64-linux-gnu.so\n")])])]),s("p",[t._v("moduleを有効化しておきます。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("a2enmod wsgi\n")])])]),s("p",[t._v("準備が整ったのでsite-80に先ほどのPythonアプリケーションを読み込ませましょう。\n"),s("code",[t._v("vim /etc/apache2/sites-available/site-80.conf")])]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("VirtualHost")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("*:")]),t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  DocumentRoot /var/www/html/site-80\n  WSGIScriptAlias /app /var/www/html/site-80/app.py\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("VirtualHost")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("最後にApacheをリスタートします。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" apache2 restart\n")])])]),s("p",[s("code",[t._v("http://localhost:8080/app")]),t._v(" にアクセスしてみてください。"),s("code",[t._v("Hello! This is python application!")]),t._v(" が表示されるでしょうか。")]),t._v(" "),s("p",[t._v("うまくいったら"),s("code",[t._v("app.py")]),t._v("を適当に変更して、Pythonが動的に実行されているのを確認してください。")]),t._v(" "),s("p",[t._v("またnginxから同様のアプリケーションを動かせるようにしてみてください。")]),t._v(" "),s("h3",{attrs:{id:"パフォーマンス測定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#パフォーマンス測定"}},[t._v("#")]),t._v(" パフォーマンス測定")]),t._v(" "),s("p",[t._v("ApacheにはApache Benchというパフォーマンス測定ツールがついています。これを使ってMPMの違いがどのようにパフォーマンスに影響するか確認してみましょう。")]),t._v(" "),s("p",[t._v("Apache Benchは"),s("code",[t._v("ab")]),t._v("コマンドで使用できます。試しに先ほどのPythonアプリケーションのパフォーマンスを測定してみましょう。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("ab -n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" -c "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" localhost:80/app\n")])])]),s("p",[t._v("これは"),s("code",[t._v("localhost:80/app")]),t._v("に対して合計10000リクエストを同時に100ずつ実行するコマンドです。\n実行結果には成功したリクエスト数や処理時間など、分析に使える情報が書かれています。")]),t._v(" "),s("p",[t._v("同時に1000リクエストを投げても、この時点では捌けていると思います。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("ab -n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" -c "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" localhost:80/app\n")])])]),s("p",[t._v("これだけでは面白くないので、pythonアプリにわざとディレイを入れてみましょう。")]),t._v(" "),s("p",[s("code",[t._v("vim /var/www/html/site-80/app.py")])]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" time\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("application")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("environ"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start_response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    status "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'200 OK'")]),t._v("\n    output "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("b'Hello! Thisa is python application!'")]),t._v("\n\n    response_headers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'text/plain'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Length'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("output"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    start_response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" response_headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("output"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("保存したらもう一度")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("ab -n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" -c "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" localhost:80/app\n")])])]),s("p",[t._v("を試してみましょう。理論上は3秒で全部のリクエストが成功するはずですがどうでしょうか。\nさらにもっと数を増やすとどうでしょうか。")]),t._v(" "),s("p",[t._v("他にも色んなことを試してみてください。")]),t._v(" "),s("ul",[s("li",[t._v("psコマンドでApacheのプロセスを確認して、リクエスト中に何が起こってるのか確認しましょう。\n"),s("ul",[s("li",[t._v("apache の再起動直後とパフォーマンス測定後の変化を見てみましょう")])])]),t._v(" "),s("li",[s("code",[t._v("/var/log/apache2/error.log")]),t._v(" を確認してみましょう")]),t._v(" "),s("li",[t._v("MPM(Multi-Processing-Module)をpreforkやworkerに変えるとどうなるでしょうか")]),t._v(" "),s("li",[t._v("MPMの設定を変えてパフォーマンスチューニングをしてみましょう")])]),t._v(" "),s("h3",{attrs:{id:"補足-mpmの変更"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#補足-mpmの変更"}},[t._v("#")]),t._v(" 補足: MPMの変更")]),t._v(" "),s("p",[t._v("現在のMPMの確認")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("apachectl -V "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" MPM\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Server MPM:     event")]),t._v("\n")])])]),s("p",[t._v("MPMをpreforkに変更する。")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("a2dismod mpm_event\na2enmod mpm_prefork\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" apache2 restart\napachectl -V "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" MPM\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Server MPM:     prefork")]),t._v("\n")])])]),s("credit-footer")],1)}),[],!1,null,null,null);s.default=n.exports}}]);