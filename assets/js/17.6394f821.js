(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{359:function(t,e,s){t.exports=s.p+"assets/img/network.866df4b8.png"},445:function(t,e,s){"use strict";s.r(e);var a=s(42),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"ansibleでホストの構成管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ansibleでホストの構成管理"}},[t._v("#")]),t._v(" ansibleでホストの構成管理")]),t._v(" "),a("h2",{attrs:{id:"_0-この講義について"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-この講義について"}},[t._v("#")]),t._v(" 0. この講義について")]),t._v(" "),a("p",[t._v("この講義ではハンズオン形式でAnsibleについて学びます。\nハンズオン用の教材は"),a("a",{attrs:{href:"https://github.com/iij/ansible-exercise",target:"_blank",rel:"noopener noreferrer"}},[t._v("こちら"),a("OutboundLink")],1),t._v("になります。")]),t._v(" "),a("h3",{attrs:{id:"下準備"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下準備"}},[t._v("#")]),t._v(" 下準備")]),t._v(" "),a("p",[t._v("この講義を受けるにはいくつかの環境準備が必要です。\n教材のREADMEに従い、講義当日までに環境を整えてください。")]),t._v(" "),a("h3",{attrs:{id:"ネットワーク構成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ネットワーク構成"}},[t._v("#")]),t._v(" ネットワーク構成")]),t._v(" "),a("p",[t._v("この講義で使用するコンテナのネットワーク図です。\nコンテナをVM（Virtual Machine）に見立て、ハンズオンを実施します。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(359),alt:"ネットワーク図"}})]),t._v(" "),a("p",[t._v("この講義では図中のansibleコンテナから各ホストを管理します。")]),t._v(" "),a("h2",{attrs:{id:"_1-ansibleとは"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-ansibleとは"}},[t._v("#")]),t._v(" 1. Ansibleとは")]),t._v(" "),a("p",[t._v("公式ドキュメント: "),a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.ansible.com/ansible/latest/index.html"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("Ansibleとは、IT自動化ツールです。\nサーバの設定やアプリケーションのデプロイなど、さまざまな処理を自動化できます。\n"),a("code",[t._v("IaC（Infrastructure as Code）")]),t._v("から生まれたツールで、"),a("a",{attrs:{href:"https://yaml.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("YAML"),a("OutboundLink")],1),t._v("と呼ばれる記述（解読）のしやすい言語で書くことができるため、\nサーバなどに詳しくない人にも理解しやすいです。\nまたサーバなどの状態がファイルとして記述されるため、アプリケーションのソースコードと同様にGitなどでバージョン管理できます。")]),t._v(" "),a("p",[t._v("Ansibleが実際にサーバを管理する際、基本的には"),a("a",{attrs:{href:"https://www.openssh.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenSSH"),a("OutboundLink")],1),t._v("を使って対象サーバへアクセスします。\nOpenSSHは多くのサーバにデフォルトでインストールされており、Ansible独自のデーモンをインストールする手間もなく導入しやすいです。")]),t._v(" "),a("p",[t._v("またモジュールやプラグインも多く、数多くの処理を自動化できます。")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("モジュール一覧"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/plugins/plugins.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("プラグイン一覧"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"サンプル実行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#サンプル実行"}},[t._v("#")]),t._v(" サンプル実行")]),t._v(" "),a("p",[t._v("まずは実際にAnsibleを実行してみましょう。")]),t._v(" "),a("p",[t._v("ダウンロードした"),a("a",{attrs:{href:"https://github.com/iij/ansible-exercise",target:"_blank",rel:"noopener noreferrer"}},[t._v("教材"),a("OutboundLink")],1),t._v("のフォルダ内で下記コマンドを実行しコンテナ内に入る、\nまたはVScodeの"),a("code",[t._v("Remote - Containers")]),t._v("を使い教材のフォルダを開き、コンテナ内に入ります。")]),t._v(" "),a("p",[t._v("Windows")]),t._v(" "),a("div",{staticClass:"language-powershell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[t._v("docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("compose "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("f docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("compose\\docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("compose"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yml "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),t._v("\ndocker exec "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("it docker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("compose_ansible_1 bash\n")])])]),a("p",[t._v("Mac/Linux")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("docker-compose -f docker-compose/docker-compose.yml up -d\ndocker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it docker-compose_ansible_1 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n")])])]),a("p",[t._v("Ansibleで主に使うコマンドは"),a("code",[t._v("ansible")]),t._v("と"),a("code",[t._v("ansible-playbook")]),t._v("の2つです。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/cli/ansible.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ansibleコマンド"),a("OutboundLink")],1),t._v("はアドホックにAnsibeを実行できます。\nYAMLなどのファイルを用意しなくても良いので、細かな日々の運用作業や確認作業などに使えます。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ansible-playbookコマンド"),a("OutboundLink")],1),t._v("は"),a("code",[t._v("playbook")]),t._v("と呼ばれるYAMLファイルにしたがってAnsibleを実行するコマンドになります。\n基本的にAnsibleを実行する際は、こちらのコマンドを使います。\nこのハンズオンでも主に"),a("code",[t._v("ansible-playbook")]),t._v("コマンドを使っていきます。")]),t._v(" "),a("p",[t._v("それではまずは何のファイルも編集せずに、下記のコマンドをコンテナ内で実行し、Ansibleを実行してみましょう。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible-playbook -C site.yml\n")])])]),a("p",[t._v("最後に"),a("code",[t._v("failed=0")]),t._v("と表示されていれば実行は成功です。\n教材の中にはすでに、データベース（MySQL）とJavaアプリケーションを構築するためのファイルが用意されています。\nしたがってそのまま実行するだけで、MySQLとJavaのアプリケーションがそれぞれのホスト内で起動します。")]),t._v(" "),a("p",[t._v("それでは"),a("a",{attrs:{href:"http://localhost:8080",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:8080"),a("OutboundLink")],1),t._v("にブラウザでアクセスしてみましょう！")]),t._v(" "),a("p",[t._v("...")]),t._v(" "),a("p",[t._v("何も表示されないですね。")]),t._v(" "),a("p",[t._v("それもそのはずです。\nさきほど実行したコマンドは"),a("code",[t._v("dryrun")]),t._v("すなわち、実際にデータベースやJavaアプリケーションをAnsibleが構築したのではありません。\nAnsibleが「もしも実行していたらこういう結果になる」というログを表示しただけです。\nしたがって実際の処理は行われていないので、当然アプリケーションにもアクセスできません。")]),t._v(" "),a("p",[a("strong",[t._v("Ansibleの良さの1つがこの"),a("code",[t._v("dryrun")]),t._v("です。")]),t._v("\n実際にAnsibleを実行したときとほぼ同じ内容を得ることができるため、作業ミスを防ぐことができます。")]),t._v(" "),a("p",[t._v("さて、では下記コマンドを実行して今度こそデータベースとアプリケーションを構築しましょう。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible-playbook site.yml\n")])])]),a("p",[a("code",[t._v("failed=0")]),t._v("と表示されれば実行は成功です。\nブラウザで"),a("a",{attrs:{href:"http://loclahost:8080",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://loclahost:8080"),a("OutboundLink")],1),t._v("にアクセスすると素朴なWebアプリケーションの画面が見えます。\nまた、下記コマンドでホストに対して実際にファイルがコピーされていることが確認できます。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# MySQL config file")]),t._v("\nansible db1 -m "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" -a "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cat /etc/my.cnf'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# app jar file")]),t._v("\nansible app1 -m "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" -a "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ls -l /opt/ansible-exercise/app.jar'")]),t._v("\n")])])]),a("p",[t._v("もうお気付きの人もいると思いますが、コマンドのオプションに"),a("code",[t._v("-C（--check）")]),t._v("を渡すことで"),a("code",[t._v("dryrun")]),t._v("を行うことができます。\nしたがって一般的な使い方としては、"),a("code",[t._v("-C（--check）")]),t._v("を付けてコマンドを実行し問題がないかを確認した後、\n"),a("code",[t._v("-C（--check）")]),t._v("を外して再度コマンドを実行して、本構築を行うという流れになります。")]),t._v(" "),a("p",[t._v("また、さきほど登場した"),a("code",[t._v("playbook")]),t._v("と呼ばれるYAMLファイルが"),a("code",[t._v("site.yml")]),t._v("になります。")]),t._v(" "),a("p",[t._v("Ansibleの使い方が分かったところで、いよいよファイルの作り方について学んでいきましょう。")]),t._v(" "),a("h2",{attrs:{id:"_2-ケース1-リバースプロキシの導入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-ケース1-リバースプロキシの導入"}},[t._v("#")]),t._v(" 2. [ケース1] リバースプロキシの導入")]),t._v(" "),a("p",[t._v("さきほどのセクションで構築したデータベースとアプリケーションを流用します。\n現在の状態は、ブラウザから直接アプリケーションに"),a("code",[t._v("HTTP")]),t._v("でアクセスしている状態です。\nnginxを導入し、"),a("code",[t._v("HTTPS")]),t._v("でアクセスしてみましょう。")]),t._v(" "),a("h3",{attrs:{id:"ディレクトリ構造"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ディレクトリ構造"}},[t._v("#")]),t._v(" ディレクトリ構造")]),t._v(" "),a("p",[t._v("まず、ディレクトリ構造とそれぞれの役割について説明します。\n下記は教材のディレクトリ構造の一部抜粋です。\nAnsibleに関わるファイルやディレクトリのみを抜粋しています。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("├── ansible.cfg  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Ansibleの設定ファイル")]),t._v("\n├── inventories  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 管理対象サーバの情報を格納するディレクトリ")]),t._v("\n│   ├── group_vars  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# グループごとの変数ファイルを格納するファイル")]),t._v("\n│   │   └── all.yml  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# すべてのグループに適用される変数ファイル")]),t._v("\n│   └── hosts  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# サーバのIPやSSHのユーザやグループなどを記述するファイル")]),t._v("\n├── playbooks  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 実行用ファイルを格納するディレクトリ。各ファイルはsite.ymlからインポートします。")]),t._v("\n│   ├── acl.yml\n│   ├── app.yml\n│   ├── db.yml\n│   └── rp.yml\n├── roles  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ロールを格納するディレクトリ。Ansibleの実行はロールと呼ばれるまとまりで管理されます。")]),t._v("\n│   └── webapp\n│       ├── defaults\n│       │   └── main.yml  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ロール内で使用される変数のデフォルト値を定義するファイル")]),t._v("\n│       ├── files  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# サーバへ配布したいファイルを格納するディレクトリ")]),t._v("\n│       ├── handlers\n│       │   └── main.yml  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ハンドラタスクを定義するファイル")]),t._v("\n│       ├── tasks\n│       │   └── main.yml  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Ansibleの具体的な処理内容を記述するファイル")]),t._v("\n│       └── templates  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# サーバへ配布したいJinja2テンプレートを使ったファイルを格納するディレクトリ")]),t._v("\n├── site.yml  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# playbookファイル")]),t._v("\n└── vars\n    └── proxy.yml  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Proxy配下でハンズオンを実施するためのファイル")]),t._v("\n")])])]),a("p",[t._v("さらに詳しく知りたい人はAnsibleの"),a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ベストプラクティス"),a("OutboundLink")],1),t._v("をご覧ください。")]),t._v(" "),a("h3",{attrs:{id:"ファイル編集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ファイル編集"}},[t._v("#")]),t._v(" ファイル編集")]),t._v(" "),a("p",[t._v("それではファイルを作成してみましょう。\nTLSの証明書に加え、いくつかの設定ファイルはすでに用意してあります。\n皆さんには下記4つのファイルを編集してもらいます。")]),t._v(" "),a("h4",{attrs:{id:"roles-nginx-tasks-main-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#roles-nginx-tasks-main-yml"}},[t._v("#")]),t._v(" roles/nginx/tasks/main.yml")]),t._v(" "),a("p",[t._v("nginxを構築するためのタスクファイルです。\n"),a("a",{attrs:{href:"http://nginx.org/en/linux_packages.html#RHEL-CentOS",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("のインストール手順に加え、設定ファイルや証明書の配布を行っています。")]),t._v(" "),a("p",[t._v("Ansibleはモジュールと呼ばれるものを使って、さまざまな処理を行います。\nAnsibleに組込み済みのモジュールは"),a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("にリストアップされており、各モジュールごとの書き方が載っています。\nモジュールを自作して使うこともできますが、基本的には上記のサイトから行いたい処理に合ったモジュールを探し、タスクファイルを作ります。")]),t._v(" "),a("p",[t._v("下記の内容を教材の"),a("code",[t._v("roles/nginx/tasks/main.yml")]),t._v("にコピーしましょう。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install yum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("utils\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("utils\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" present\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ proxy_env | default({}) }}"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" add Nginx repository\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum_repository")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("stable\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx stable repo'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("baseurl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//nginx.org/packages/centos/$releasever/$basearch/\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gpgkey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//nginx.org/keys/nginx_signing.key\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yes\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install Nginx\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx-{{ nginx_version }}-1.el7.ngx.x86_64"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" present\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ proxy_env | default({}) }}"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ignore_errors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ ansible_check_mode }}"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" create ssl directory\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" directory\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/nginx/ssl\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("owner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0600")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy ssl files\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("copy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etc/nginx/ssl/{{ item }}"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/nginx/ssl/{{ item }}"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0400")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" server.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" server.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dhparam.pem\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" remove default config file\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" absent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/nginx/conf.d/default.conf\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("notify")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" reload nginx\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy config file\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" etc/nginx/conf.d/app.conf.j2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/nginx/conf.d/app.conf\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("owner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0644")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("notify")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" reload nginx\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start nginx\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("systemd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" started\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yes\n")])])]),a("p",[t._v("nginxの構築に使用したモジュールの一覧は以下になります。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("モジュール名")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("説明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/yum_module.html#yum-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("yum"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("yumコマンドを使ってRPMパッケージを操作できるモジュールです。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/yum_repository_module.html#yum-repository-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("yum-repository"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("yumで使用するリポジトリを操作できるモジュールです。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/file_module.html#file-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("file"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("対象サーバのファイルシステムを操作できるモジュールです。"),a("br"),t._v("ディレクトリやファイルを作成/削除したり、ファイルのオーナーやパーミッションを変更できたりします。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/copy_module.html#copy-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("copy"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("対象サーバへファイルをコピーできるモジュールです。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/template_module.html#template-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("template"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("対象サーバへファイルをコピーできるモジュールです。"),a("code",[t._v("copy")]),t._v("との違いはファイル内に"),a("code",[t._v("Jinja2")]),t._v("テンプレートが使える点です。"),a("br"),t._v("ファイル内で変数を使いたい場合はこちらを使います。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/modules/systemd_module.html#systemd-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("systemd"),a("OutboundLink")],1)]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[a("a",{attrs:{href:"https://wiki.archlinux.jp/index.php/Systemd",target:"_blank",rel:"noopener noreferrer"}},[t._v("systmed"),a("OutboundLink")],1),t._v("によって管理されるプロセスを操作できるモジュールです。"),a("br"),t._v("基本的にはLinux環境でプロセスを常駐させる場合はこれを使います。")])])])]),t._v(" "),a("h4",{attrs:{id:"roles-nginx-templates-etc-nginx-conf-d-app-conf-j2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#roles-nginx-templates-etc-nginx-conf-d-app-conf-j2"}},[t._v("#")]),t._v(" roles/nginx/templates/etc/nginx/conf.d/app.conf.j2")]),t._v(" "),a("p",[t._v("nginxの設定ファイルです。\nファイル内で変数を使用しているので"),a("code",[t._v("templates")]),t._v("下に配置しています。")]),t._v(" "),a("p",[t._v("分かりやすさのために、配置するディレクトリをコピー先のパスと同じにしています。\nAnsibleやサーバの構築/運用に慣れないうちは、こうしておくことをお勧めします。")]),t._v(" "),a("p",[t._v("下記の内容を教材の"),a("code",[t._v("roles/nginx/templates/etc/nginx/conf.d/app.conf.j2")]),t._v("にコピーしましょう。")]),t._v(" "),a("div",{staticClass:"language-jinja extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("upstream app_backend {\n    {% for app in nginx_backends %}\n    server {{ app.host }}:{{ app.port }} max_fails=1 fail_timeout=3s;\n    {% endfor %}\n}\n\nserver {\n  listen {{ nginx_https_port }} ssl;\n\n  ssl_protocols TLSv1.2 TLSv1.3;\n  ssl_certificate /etc/nginx/ssl/server.crt;\n  ssl_certificate_key /etc/nginx/ssl/server.key;\n  ssl_dhparam /etc/nginx/ssl/dhparam.pem;\n\n  location / {\n    proxy_set_header  Host  $http_host;\n    proxy_set_header  X-Real-IP  $remote_addr;\n    proxy_set_header  X-Forwarded-Host  $server_name;\n    proxy_set_header  X-Forwarded-Server  $host;\n    proxy_set_header  X-Forwarded-Proto  $scheme;\n    proxy_set_header  X-Forwarded-Port {{ nginx_https_port }};\n    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;\n    proxy_pass  http://app_backend;\n  }\n\n  error_page 404 /404.html;\n\n  error_page 500 502 503 504 /50x.html;\n  location = /50x.html {\n    root  /usr/share/nginx/html;\n  }\n}\n")])])]),a("p",[t._v("nginxの設定について説明することは主題から外れるので、この講義では行いません。\n興味のある人はnginxの"),a("a",{attrs:{href:"http://nginx.org/en/docs/http/configuring_https_servers.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("をご覧ください。")]),t._v(" "),a("h4",{attrs:{id:"playbooks-rp-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#playbooks-rp-yml"}},[t._v("#")]),t._v(" playbooks/rp.yml")]),t._v(" "),a("p",[t._v("nginxを構築するための実行ファイルです。\n対象サーバとロールを指定することで、指定したサーバにnginxを構築できます。")]),t._v(" "),a("p",[t._v("下記の内容を教材の"),a("code",[t._v("playbooks/rp.yml")]),t._v("にコピーしましょう。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" set up the reverse proxy server\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rp\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("become")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" no\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gather_facts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" no\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("vars_files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ../vars/proxy.yml\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" roles/nginx\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n")])])]),a("h4",{attrs:{id:"site-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#site-yml"}},[t._v("#")]),t._v(" site.yml")]),t._v(" "),a("p",[t._v("最後に、さきほど作った"),a("code",[t._v("playbooks/rp.yml")]),t._v("をインポートする様に教材の"),a("code",[t._v("site.yml")]),t._v("に下記を追記します。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("import_playbook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" playbooks/rp.yml\n")])])]),a("h3",{attrs:{id:"実行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実行"}},[t._v("#")]),t._v(" 実行")]),t._v(" "),a("p",[t._v("さて、ファイルがすべて準備できたらいよいよAnsibleを実行します。")]),t._v(" "),a("p",[t._v("さきほど紹介したとおり、まずは"),a("code",[t._v("-C（--check）")]),t._v("オプションを付け、"),a("code",[t._v("dryrun")]),t._v("により結果を確認しましょう。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible-playbook -C site.yml\n")])])]),a("p",[a("code",[t._v("failed=0")]),t._v("の表示があれば実行は成功です。\n"),a("code",[t._v("-C（--check）")]),t._v("オプションを外し、本実行を行いましょう。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible-playbook site.yml\n")])])]),a("p",[a("code",[t._v("failed=0")]),t._v("と表示されれば実行は成功です。")]),t._v(" "),a("p",[t._v("ブラウザで"),a("a",{attrs:{href:"https://localhost:8443",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://localhost:8443"),a("OutboundLink")],1),t._v("にアクセスして確認します。\n自己証明書を使っているためブラウザから注意文言が表示されますが、スキップしてください。\nすると、さきほどと同じ画面が表示されます。")]),t._v(" "),a("p",[t._v("ここで、もう一つ注目してほしい部分があります。\nAnsibleの実行ログを眺めると、データベースやJavaアプリケーションの構築用のタスクもステータスが"),a("code",[t._v("ok")]),t._v("の状態で、実行されているのが分かると思います。\nまたさきほど実行した"),a("code",[t._v("ansible-playbook site.yml")]),t._v("をもう一度実行すると、nginxの構築タスクも含め、すべてのタスクのステータスが"),a("code",[t._v("ok")]),t._v("になります。")]),t._v(" "),a("p",[t._v("ある操作を何回行っても等価であるとき、その操作を"),a("code",[t._v("冪等")]),t._v("であると言います。\n"),a("strong",[t._v("Ansibleの良さの1つがこの"),a("code",[t._v("冪等")]),t._v("性です。")]),t._v("\n基本的にAnsibleは同じタスクを何回実行しても、差分のないタスクは実行されません。\nすなわち、ファイルを変更しない限りホストに対して余計な変更が加わらず、安全です。")]),t._v(" "),a("p",[t._v("しかしこの"),a("code",[t._v("冪等")]),t._v("性は意識していないと壊れてしまう場合があります。\nAnsibleを使うときは"),a("code",[t._v("冪等")]),t._v("性に注意を払いましょう。")]),t._v(" "),a("h2",{attrs:{id:"_3-ケース2-バージョンアップ-スケーリング"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-ケース2-バージョンアップ-スケーリング"}},[t._v("#")]),t._v(" 3. [ケース2] バージョンアップ & スケーリング")]),t._v(" "),a("p",[t._v("さて、nginxを導入して初期構築タスクを自動化できました。\n次は変数やホスト情報を編集して、運用タスクを自動化してみましょう。")]),t._v(" "),a("h3",{attrs:{id:"バージョンアップ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#バージョンアップ"}},[t._v("#")]),t._v(" バージョンアップ")]),t._v(" "),a("p",[t._v("まずはnginxのバージョンアップをしてみましょう。")]),t._v(" "),a("p",[t._v("さきほどインストールされたnginxのバージョンは少し古めの"),a("code",[t._v("1.16.1")]),t._v("です。\nこのバージョンは"),a("code",[t._v("roles/nginx/defaults/main.yml")]),t._v("に"),a("code",[t._v("nginx_version")]),t._v("という変数として定義されています。\nまた、下記のコマンドを実行することで、確認することもできます。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible rp1 -m "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" -a "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx -V'")]),t._v("\n")])])]),a("p",[t._v("これを"),a("code",[t._v("1.18.0")]),t._v("にアップデートしてみたいと思います。\n教材の"),a("code",[t._v("inventories/group_vars/all.yml")]),t._v("に下記を追記しましょう。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx_version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1.18.0\n")])])]),a("p",[t._v("Ansibleには変数の優先度が設定されており、同じ名前の変数は優先度の高いほうが有効になります。\nこれを利用することでロールの完全性を担保しつつ、タスクの内容を編集できます。")]),t._v(" "),a("p",[t._v("具体的な優先度は"),a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("をご覧ください。")]),t._v(" "),a("p",[t._v("ファイルの準備ができたらAnsibleを実行します。\nさきほどと同様に"),a("code",[t._v("ansible-playbook -C site.yml")]),t._v("を実行しても良いですが、\n実行したいのはnginxのタスクだけですので、データベースやアプリケーションのタスクは余計です。")]),t._v(" "),a("p",[t._v("そこで実行コマンドを下記に変更します。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible-playbook -C site.yml -t nginx\n")])])]),a("p",[t._v("すると、さきほどまで実行されていたデータベースやアプリケーション構築のタスクは実行されず、nginxの構築タスクだけが実行されます。\nまた"),a("code",[t._v("changed=1")]),t._v("となり、nginxのインストールのタスクだけが変更されることが確認できます。")]),t._v(" "),a("p",[t._v("Ansibleにはタグという機能があり、タスクやロールなどに任意の値を設定できます。\nこれを利用することで、Ansible実行時に任意のタスクのみを実行する/しないことができます。\n実はさきほどの"),a("code",[t._v("playbooks/rp.yml")]),t._v("にタグが設定してありました。")]),t._v(" "),a("p",[t._v("タグは増やしすぎても管理がたいへんになるので、ある程度のまとまりやよく使うタスクにのみ付与するのが良いでしょう。\nタグの詳細については"),a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("をご覧ください。")]),t._v(" "),a("p",[a("code",[t._v("failed=0")]),t._v("という表示が確認できたら"),a("code",[t._v("-C（--check）")]),t._v("のオプションを外し、上記コマンドを実行しましょう。")]),t._v(" "),a("p",[t._v("本実行が完了したら、さきほどの確認コマンドを実行してバージョンが上がったことを確認してみましょう。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible rp1 -m "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" -a "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx -V'")]),t._v("\n")])])]),a("h3",{attrs:{id:"スケールアップ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#スケールアップ"}},[t._v("#")]),t._v(" スケールアップ")]),t._v(" "),a("p",[t._v("次はアプリケーションサーバをスケールアップ（増設）してみましょう。\nと言っても増設用のサーバはすでにコンテナとして起動してあるので、皆さんがすべきことは下記2つのファイルの編集です。")]),t._v(" "),a("h4",{attrs:{id:"inventories-hosts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#inventories-hosts"}},[t._v("#")]),t._v(" inventories/hosts")]),t._v(" "),a("p",[t._v("まずはAnsibleの管理対象にアプリケーション増設用のサーバ（app2）を追加します。\n教材の"),a("code",[t._v("inventories/host")]),t._v("を下記のように追記してください。")]),t._v(" "),a("div",{staticClass:"language-diff extra-class"},[a("pre",{pre:!0,attrs:{class:"language-diff"}},[a("code",[t._v("[app]\napp1\n"),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[a("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token line"}},[t._v(" app2\n")])])])])]),a("p",[t._v("これで"),a("code",[t._v("app")]),t._v("グループの中に"),a("code",[t._v("app2")]),t._v("サーバを追加できました。")]),t._v(" "),a("p",[t._v("Ansibleには管理対象のホストをグルーピングし、設定したグループ単位でAnsibleを実行したり、変数を設定できたりします。\nこうすることで、柔軟かつ効率的にサーバを管理できます。\nこの講義ではそれぞれ1台しかありませんが、データベースサーバやリバースプロキシサーバもグループに分けられています。")]),t._v(" "),a("p",[t._v("Ansibleのグループやホストについての詳細は"),a("RouterLink",{attrs:{to:"hhttps://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups"}},[t._v("公式ドキュメント")]),t._v("をご覧ください。")],1),t._v(" "),a("h4",{attrs:{id:"inventories-group-vars-all-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#inventories-group-vars-all-yml"}},[t._v("#")]),t._v(" inventories/group_vars/all.yml")]),t._v(" "),a("p",[t._v("次に変数ファイルを編集します。\nさきほども編集した"),a("code",[t._v("inventories/group_vars/all.yml")]),t._v("に下記のように追記します。")]),t._v(" "),a("div",{staticClass:"language-diff extra-class"},[a("pre",{pre:!0,attrs:{class:"language-diff"}},[a("code",[t._v("nginx_backends:\n"),a("span",{pre:!0,attrs:{class:"token unchanged"}},[a("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),a("span",{pre:!0,attrs:{class:"token line"}},[t._v(" - host: 192.0.2.12\n")]),a("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),a("span",{pre:!0,attrs:{class:"token line"}},[t._v('   port: "{{ server_port }}"\n')])]),a("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[a("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token line"}},[t._v(" - host: 192.0.2.13\n")]),a("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token line"}},[t._v('   port: "{{ server_port }}"\n')])])])])]),a("p",[t._v("これはnginxが通信を経由させるサーバのリストを格納している変数です。\nここに新しく"),a("code",[t._v("app2")]),t._v("サーバの情報を追記することで、nginxが"),a("code",[t._v("app2")]),t._v("サーバにも通信を流してくれます。")]),t._v(" "),a("p",[t._v("nginxはロードバランサ（負荷分散装置）としての機能も備えているので、\nこうすることで今まで"),a("code",[t._v("app1")]),t._v("サーバにしかいかなかった通信が"),a("code",[t._v("app2")]),t._v("にも行くようになり、負荷を分散できます。")]),t._v(" "),a("p",[t._v("nginxの機能について詳しく説明することは主題から外れてしまいますので、この講義では行いません。\nさらに詳しく知りたい人はnginxの"),a("a",{attrs:{href:"http://nginx.org/en/docs/http/load_balancing.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("をご覧ください。")]),t._v(" "),a("h4",{attrs:{id:"実行-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実行-2"}},[t._v("#")]),t._v(" 実行")]),t._v(" "),a("p",[t._v("さて、ファイルの準備ができたらAnsibleを実行します。\nもうお馴染みとなった下記コマンドを実行します。")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("ansible-playbook -C site.yml\n")])])]),a("p",[a("code",[t._v("dryrun")]),t._v("で結果を確認すると、新たに"),a("code",[t._v("app2")]),t._v("サーバが増えていることが確認できます。\nまた、nginxの設定ファイルの差分も確認できるはずです。")]),t._v(" "),a("p",[a("code",[t._v("failed=0")]),t._v("と表示されていれば問題ありません。\n"),a("code",[t._v("-C（--check）")]),t._v("のオプションを外し、本実行を行いましょう。")]),t._v(" "),a("p",[t._v("コマンドが終了したら、ブラウザで"),a("a",{attrs:{href:"https://localhost:8443",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://localhost:8443"),a("OutboundLink")],1),t._v("にアクセスして確認してみましょう。")]),t._v(" "),a("p",[t._v("このWebアプリケーションは動作しているサーバのホスト名を画面に表示しています。\n新しくブラウザを開き"),a("a",{attrs:{href:"https://localhost:8443",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://localhost:8443"),a("OutboundLink")],1),t._v("にアクセスすると、ホスト名の表記が変わっているはずです。")]),t._v(" "),a("p",[t._v("これにより、nginxが正常に負荷を分散してくれていることが確認できます。")]),t._v(" "),a("p",[t._v("ここで、もう一つ注目していただきたいところがあります。\nAnsibleの実行ログの中に、"),a("code",[t._v("RUNNING HANDLER")]),t._v("という表記が確認できると思います。\nさきほどと同じ様に"),a("code",[t._v("ansible-playbook site.yml")]),t._v("と実行した場合、この表記がなくなると思います。")]),t._v(" "),a("p",[t._v("これはAnsibleのハンドラという機能になります。\nこれは、ハンドラを設定したタスクが"),a("code",[t._v("changed")]),t._v("のときにのみ実行されるタスクを設定できる機能です。\n実際に実行されるタスクは各ロールの"),a("code",[t._v("handlers/main.yml")]),t._v("に書かれています。")]),t._v(" "),a("p",[t._v("これにより設定ファイルが変更された場合のみ、アプリケーションやデータベースなどのプロセスを再起動できます。\n影響範囲を限定できるため、安全にホストに対して変更を加えることができます。")]),t._v(" "),a("p",[t._v("詳細は"),a("a",{attrs:{href:"https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#handlers-running-operations-on-change",target:"_blank",rel:"noopener noreferrer"}},[t._v("公式ドキュメント"),a("OutboundLink")],1),t._v("をご覧ください。")]),t._v(" "),a("h2",{attrs:{id:"_4-応用課題-aclの導入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-応用課題-aclの導入"}},[t._v("#")]),t._v(" 4. [応用課題] ACLの導入")]),t._v(" "),a("p",[t._v("応用課題として、全サーバにACL（Access Control List）を導入してみましょう。")]),t._v(" "),a("p",[t._v("ACLとは、通信の（不）許可を設定することで、サーバのセキュリティレベルを高める手法のひとつです。\n多くのプロダクション環境のサーバではACLが設定され、セキュリティレベルを高めています。")]),t._v(" "),a("p",[t._v("この講義で使用したサーバのここまでの状態は、どんな通信でも許可してしまうセキュリティ的には脆弱な状態です（ローカル環境ですので攻撃されたりすることはありません）。")]),t._v(" "),a("p",[t._v("そこで、ACLの実装のひとつである"),a("a",{attrs:{href:"https://linuxjm.osdn.jp/html/iptables/man8/iptables.8.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("iptables"),a("OutboundLink")],1),t._v("を導入し、サーバのセキュリティレベルを向上させましょう。")]),t._v(" "),a("p",[t._v("教材の"),a("code",[t._v("roles/iptables")]),t._v("にロールのひな型を用意しておきました。\nこのひな型を利用/編集して、全サーバにACLを導入できる様にしてみましょう。")]),t._v(" "),a("p",[t._v("また、以下の表の通りに各サーバのポートを許可しましょう。\n適切にポートを許可しなかった場合、Web画面が正常に表示されなくなります。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("サーバ名")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("グループ名")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("許可ポート")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("db1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("db")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("3306")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("app[1,2]")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("app")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("8080")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("rp1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("rp")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("8443")])])])]),t._v(" "),a("h3",{attrs:{id:"ヒント"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ヒント"}},[t._v("#")]),t._v(" ヒント")]),t._v(" "),a("p",[t._v("いくつかヒントを載せておきます。")]),t._v(" "),a("ol",[a("li",[t._v("CentOS7で"),a("code",[t._v("iptables")]),t._v("をインストールする場合は"),a("code",[t._v("yum")]),t._v("で"),a("code",[t._v("iptables-services")]),t._v("をインストールする")]),t._v(" "),a("li",[t._v("設定ファイルは"),a("code",[t._v("/etc/sysconfig/iptables")])]),t._v(" "),a("li",[t._v("Ansibleのすべての管理対象サーバは"),a("code",[t._v("all")]),t._v("グループに自動的に属している")]),t._v(" "),a("li",[t._v("各グループの変数は"),a("code",[t._v("inventories/group_vars/<group_name>.yml")]),t._v("で設定できる")]),t._v(" "),a("li",[t._v("まずは"),a("code",[t._v("roles/iptables")]),t._v("の中身を確認してみるとよいでしょう")])]),t._v(" "),a("h3",{attrs:{id:"解答例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答例"}},[t._v("#")]),t._v(" 解答例")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/iij/ansible-exercise/tree/solution",target:"_blank",rel:"noopener noreferrer"}},[t._v("教材のsolutionブランチ"),a("OutboundLink")],1),t._v("が解答例になっています。\nこの解答例以外にも多くの実現方法がありますが、参考にしてもらえればと思います。")]),t._v(" "),a("p",[t._v("他のファイルについても、この講義を受けた後の最終的なファイルの内容になっています。\nハンズオンを進める中でつまずくことがあれば、参考にしてもらえればと思います。")]),t._v(" "),a("credit-footer")],1)}),[],!1,null,null,null);e.default=n.exports}}]);