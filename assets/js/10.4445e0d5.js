(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{481:function(s,t,a){s.exports=a.p+"assets/img/apache-start.82b13324.png"},482:function(s,t,a){s.exports=a.p+"assets/img/site-80.7a41e96d.png"},483:function(s,t,a){s.exports=a.p+"assets/img/site-81.19ee5e97.png"},484:function(s,t,a){s.exports=a.p+"assets/img/nginx_html.ac55e229.png"},485:function(s,t,a){s.exports=a.p+"assets/img/nginx-proxy.drawio.50845ff4.png"},536:function(s,t,a){"use strict";a.r(t);var e=a(45),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"apache-nginx-を触ってみよう"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#apache-nginx-を触ってみよう"}},[s._v("#")]),s._v(" Apache + Nginx を触ってみよう")]),s._v(" "),e("h2",{attrs:{id:"事前準備"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#事前準備"}},[s._v("#")]),s._v(" 事前準備")]),s._v(" "),e("p",[s._v("以下のように"),e("code",[s._v("docker pull")]),s._v("をしたあと、ハンズオン用のコンテナを立ち上げてログインしてください。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s._v("docker pull python:3.8.2-buster")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("3.8.2-buster: Pulling from library/python\n90fe46dd8199: Pull complete\n35a4f1977689: Pull complete\nbbc37f14aded: Pull complete\n74e27dc593d4: Pull complete\n4352dcff7819: Pull complete\ndeb569b08de6: Pull complete\n98fd06fa8c53: Pull complete\n7b9cc4fdefe6: Pull complete\n512732f32795: Pull complete\nDigest: sha256:003990f08716aef3eb0772f9d9fa8e27603f2b863c56c649a3e9693ddb5b41f1\nStatus: Downloaded newer image for python:3.8.2-buster\ndocker.io/library/python:3.8.2-buster\n")]),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s._v("docker run --rm -itd --name test-debian -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(":81 -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8088")]),s._v(":88 -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8089")]),s._v(":89 python:3.8.2-buster /bin/bash")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("b8c0df20d1540aba0342362d88d1b0cb9ec94a1877ae1ca5aea5583880193a8e\n")]),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s._v("docker "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it test-debian /bin/bash")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("root@b8c0df20d154:/#\n")])])])]),e("p",[s._v("Apacheとnginxをインストールします。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token info punctuation"}},[e("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@b8c0df20d154")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" update")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("Get:1 http://security.debian.org/debian-security buster/updates InRelease [65.4 kB] \nGet:2 http://deb.debian.org/debian buster InRelease [121 kB]                        \nGet:3 http://deb.debian.org/debian buster-updates InRelease [51.9 kB]\nGet:4 http://security.debian.org/debian-security buster/updates/main amd64 Packages [289 kB]\nGet:5 http://deb.debian.org/debian buster/main amd64 Packages [7907 kB]\nGet:6 http://deb.debian.org/debian buster-updates/main amd64 Packages [10.9 kB]\nFetched 8445 kB in 18s (471 kB/s)\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\n103 packages can be upgraded. Run 'apt list --upgradable' to see them.\n\n")]),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token info punctuation"}},[e("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@b8c0df20d154")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y apache2 apache2-dev nginx "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("Reading package lists... Done\nBuilding dependency tree\nReading state information... Done\nThe following additional packages will be installed:\n  apache2-bin apache2-data apache2-utils autopoint bsdmainutils debhelper dh-autoreconf dh-strip-nondeterminism dwz geoip-database gettext gettext-base\n  groff-base intltool-debian libapr1-dev libaprutil1-dbd-sqlite3 libaprutil1-dev libaprutil1-ldap libarchive-cpio-perl libarchive-zip-perl libbrotli1\n  libfile-stripnondeterminism-perl libgd3 libgeoip1 libgpm2 libjansson4 libldap-2.4-2 libldap2-dev liblua5.2-0 \n\n~~~略~~~\n\nSetting up dh-strip-nondeterminism (1.1.2-1) ...\nSetting up apache2-dev (2.4.38-3+deb10u4) ...\nProcessing triggers for mime-support (3.62) ...\nProcessing triggers for hicolor-icon-theme (0.17-2) ...\nProcessing triggers for libc-bin (2.28-10) ...\nroot@b8c0df20d154:/#\n")])])])]),e("p",[s._v("以下のコマンドでバージョンが表示されれば成功です。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token info punctuation"}},[e("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@b8c0df20d154")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s._v("apache2 -v")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("Server version: Apache/2.4.38 (Debian)\nServer built:   2020-08-25T20:08:29\n\n")]),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token info punctuation"}},[e("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@b8c0df20d154")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s._v("nginx -v")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("nginx version: nginx/1.14.2\n")])])])]),e("h2",{attrs:{id:"webサーバー"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#webサーバー"}},[s._v("#")]),s._v(" Webサーバー")]),s._v(" "),e("p",[s._v("いわゆる「Webサーバー」とは、HTTP(Hypertext Transfer Protocol)でリクエストを受け、HTTPでレスポンスを返すソフトウェアの通称です。\n僕らがブラウザなどにURLを入力したりリンクをクリックした時、Webページが表示されるのはWebサーバーが要求したURLに対するレスポンスを返しているからです。またスマホアプリの裏で行われるサーバーとのやりとりには多くの場合HTTPが使われており、ここでもWebサーバーがゲームのデータなどをレスポンスとして返しています。")]),s._v(" "),e("p",[s._v("Webサーバのシンプルな機能は前述の通りですが、実際にはユースケースに合わせてさまざまな役割を持ちます。")]),s._v(" "),e("ul",[e("li",[s._v("HTMLやテキストファイルの配信")]),s._v(" "),e("li",[s._v("動的アプリケーションのホスティング\n"),e("ul",[e("li",[s._v("JavaやPythonやPHPなど、プログラムで生成されたレスポンスを返す")])])]),s._v(" "),e("li",[s._v("HTTP通信を別のサーバーに中継するプロキシ")]),s._v(" "),e("li",[s._v("Basic認証などによる認証処理")]),s._v(" "),e("li",[s._v("ACL(Access Control List)によるアクセス制御・不正な通信への防御")])]),s._v(" "),e("p",[s._v("簡単なWebサーバーであればどのプログラミング言語でも比較的簡単に作ることができます。\nしかし実用上はさまざまな機能をもち、セキュリティやパフォーマンスについても長年改善されてきた専用のソフトウェアが必要になり、それがいわゆる「Webサーバーソフトウェア」と呼ばれるツールです。")]),s._v(" "),e("p",[s._v("有名どころを挙げてみると")]),s._v(" "),e("ul",[e("li",[s._v("Apache HTTP Server")]),s._v(" "),e("li",[s._v("IIS")]),s._v(" "),e("li",[s._v("lighttpd")]),s._v(" "),e("li",[s._v("nginx")])]),s._v(" "),e("p",[s._v("あたりでしょうか。Linuxサーバー上で動かすのであればほぼApacheとnginxの2択になると思います。")]),s._v(" "),e("p",[s._v("また最近ではenvoyやtraefikなど、クラウドやKubernetesという文脈ではプロキシ機能に特化したソフトウェアが使われることも多くなりました。")]),s._v(" "),e("h2",{attrs:{id:"apache-と-nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#apache-と-nginx"}},[s._v("#")]),s._v(" Apache と Nginx")]),s._v(" "),e("h3",{attrs:{id:"apache-http-server"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#apache-http-server"}},[s._v("#")]),s._v(" Apache HTTP Server")]),s._v(" "),e("p",[s._v("「Apache HTTP Server」はnginxと並んで2台勢力を誇っているWebサーバソフトウェアのひとつです。 CentOSではhttpdという名前になっていたり、単にApacheと呼ばれます。")]),s._v(" "),e("p",[s._v("「Apache HTTP Server」は「Apacheソフトウェア財団」によって管理されるOSSで、20年以上の歴史を持ちます。 世界的にもっとも普及したWebサーバで、LAMP（Linux, Apache, MySQL, PHP）環境のひとつにも挙げられ、nginxと並んで2大勢力を誇ります。\n(参考: "),e("a",{attrs:{href:"https://news.netcraft.com/archives/2021/04/30/april-2021-web-server-survey.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("April 2021 Web Server Survey"),e("OutboundLink")],1),s._v(")")]),s._v(" "),e("p",[s._v("正式名称は「Apache HTTP Server」ですが、歴史的経緯などからCentOSではhttpdという名前になっていたり、単にApacheと呼ばれたりします。")]),s._v(" "),e("p",[s._v("以前は大量のリクエストを受けた際にプロセスをforkできず、リクエストを捌き切れなくなる（いわゆるC10K問題）ことが問題視されました。 その際nginxをはじめとして新しいWebサーバーソフトウェアが登場しましたが、Apache自体もworkerやevent MPMといった新しい仕組みを導入し、動作も安定していることからいまだに高いシェアを占めています。")]),s._v(" "),e("h3",{attrs:{id:"nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[s._v("#")]),s._v(" nginx")]),s._v(" "),e("p",[s._v("nginxは2004年頃、当時のWebサーバーが抱えていたパフォーマンス問題(C10K問題)の解決を背景に開発が進められました。\n当時からApache 2.2は高機能で信頼性が高く、ある種成熟したソフトウェアでしたが、それに対してnginxは軽量さと高パフォーマンスに焦点をあてて開発されており、Apacheのカバーしきれないユースケースに対して力を発揮しました。")]),s._v(" "),e("p",[s._v("特に後段のサーバーにリクエストを流すリバースプロキシ・ロードバランサ機能がとても使いやすく、どちらかというと軽量なリクエストを大量に捌くのに向いています。")]),s._v(" "),e("h2",{attrs:{id:"apache-ハンズオン"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#apache-ハンズオン"}},[s._v("#")]),s._v(" Apache ハンズオン")]),s._v(" "),e("h3",{attrs:{id:"htmlファイルの配信-check1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#htmlファイルの配信-check1"}},[s._v("#")]),s._v(" HTMLファイルの配信(check1)")]),s._v(" "),e("p",[s._v("まずはApacheを起動しましょう。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" apache2 start")])]),s._v("\n")])])]),e("p",[s._v("ブラウザを開いて"),e("a",{attrs:{href:"http://localhost:8080",target:"_blank",rel:"noopener noreferrer"}},[s._v("localhost:8080"),e("OutboundLink")],1),s._v("にアクセスしてみてください。以下のような画面が表示されれば成功です。")]),s._v(" "),e("p",[e("img",{attrs:{src:a(481),alt:"apache-start"}})]),s._v(" "),e("p",[s._v("表示されたページはデフォルトのHTMLファイルです。これを自分で作成したページに置き換えてみましょう。 デフォルトではDocument Rootは/var/www/html/に設定されています。")]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),e("p",[s._v("Document RootはApacheが静的ファイルを配信するためのroot directoryです。")])]),s._v(" "),e("p",[s._v("この下にある"),e("code",[s._v("index.html")]),s._v("ファイルを自分の物に置き換えてみましょう。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/www/html/")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" index.html _index.html")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hello Bootcamp!!'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" index.html")])]),s._v("\n")])])]),e("p",[s._v("再び"),e("code",[s._v("http://localhost:8080/")]),s._v("を開くと"),e("code",[s._v("Hello Bootcamp!!")]),s._v("が表示されるのを確認してください。")]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),e("p",[e("code",[s._v("http://localhost:8080/")]),s._v(" のようにファイル名を指定せずディレクトリ（この場合はルートディレクトリ）を指定した場合、Apacheは"),e("code",[s._v("index.html")]),s._v("を返すようにデフォルトで設定されています。\nこの設定は変更できます。")])]),s._v(" "),e("p",[s._v("Document Root配下にディレクトリを作成するとブラウザからも同様にアクセスできます。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /var/www/html/hoge")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hello HUGA!!'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/www/html/hoge/huga.txt")])]),s._v("\n")])])]),e("p",[e("code",[s._v("http://localhost:8080/hoge/huga.txt")]),s._v(" にアクセスすると追加したファイルが表示されます。")]),s._v(" "),e("h3",{attrs:{id:"virtualhost-の設定-check2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#virtualhost-の設定-check2"}},[s._v("#")]),s._v(" VirtualHost の設定(check2)")]),s._v(" "),e("p",[s._v("1つのApacheで複数のWebサイトを管理したいことがあります。異なるIPアドレスやアドレス、port番号からアクセスされた時にDocument Rootなどを切り替えたいときは"),e("code",[s._v("VirtualHost")]),s._v("を設定することで実現できます。")]),s._v(" "),e("p",[s._v("ここではport番号を"),e("code",[s._v("80")]),s._v("と"),e("code",[s._v("81")]),s._v("に分けて別々のWebサイトを設定してみます。\n(docker起動時にport forwardしているため、手元からは"),e("code",[s._v("8080")]),s._v("と"),e("code",[s._v("8081")]),s._v("からアクセスできます。)")]),s._v(" "),e("p",[s._v("まずは新しくDocument RootになるディレクトリとHTMLファイルを作成します。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /var/www/html/site-80\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /var/www/html/site-81\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'This is site 80!'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/www/html/site-80/index.html\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'This is site 81!'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/www/html/site-81/index.html\n")])])]),e("p",[s._v("次にApacheの設定をして行きます。やることは")]),s._v(" "),e("ul",[e("li",[s._v("listen portに81を追加")]),s._v(" "),e("li",[s._v("virtual host設定の追加")])]),s._v(" "),e("p",[s._v("の2つです。listen portの追加は"),e("code",[s._v("/etc/apache2/ports.conf")]),s._v("に書きましょう。\n以下のように"),e("code",[s._v("Listen 80")]),s._v(" の下に "),e("code",[s._v("Listen 81")]),s._v("の記述を追加します。")]),s._v(" "),e("div",{staticClass:"language-apache extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# If you just change the port or add more ports here, you will likely also\n# have to change the VirtualHost statement in\n# /etc/apache2/sites-enabled/000-default.conf\n\nListen 80\nListen 81\n\n<IfModule ssl_module>\n        Listen 443\n</IfModule>\n\n<IfModule mod_gnutls.c>\n        Listen 443\n</IfModule>\n\n# vim: syntax=apache ts=4 sw=4 sts=4 sr noet\n")])])]),e("p",[s._v("VitrualHostの設定は"),e("code",[s._v("/etc/apache2/sites-available")]),s._v("の下に作成して行きます。")]),s._v(" "),e("p",[e("code",[s._v("/etc/apache2/sites-available/site-80.conf")])]),s._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("VirtualHost")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("*:")]),s._v("80")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  DocumentRoot /var/www/html/site-80\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("VirtualHost")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])]),e("p",[e("code",[s._v("/etc/apache2/sites-available/site-81.conf")])]),s._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("VirtualHost")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("*:")]),s._v("81")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  DocumentRoot /var/www/html/site-81\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("VirtualHost")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])]),e("p",[s._v("設定ファイルを作成したら"),e("code",[s._v("a2dissite")]),s._v("、"),e("code",[s._v("a2ensite")]),s._v("コマンドを使って設定を有効化しましょう。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("a2dissite 000-default\na2ensite site-80\na2ensite site-81\n")])])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),e("p",[e("code",[s._v("a2dissite")]),s._v("や"),e("code",[s._v("a2ensite")]),s._v("といったコマンドは実はapache本体の機能ではありません。"),e("code",[s._v("a2ensite")]),s._v("は"),e("code",[s._v("/etc/apache2/sites-available")]),s._v("以下のファイルのsimlinkを"),e("code",[s._v("/etc/apache2/sites-enable")]),s._v("以下に追加するだけのコマンドです。\n実際のApacheは"),e("code",[s._v("/etc/apache2/sites-enable")]),s._v("以下のコンフィグファイルをloadしているため、コマンドによってサイトが有効化されたように見えるのです。")]),s._v(" "),e("p",[s._v("CentOSなど他のディストリビューションでは、これらのコマンドが存在しないことが多いので注意してください。")])]),s._v(" "),e("p",[s._v("そしてApacheをリスタートします。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" apache2 reload\n")])])]),e("p",[e("code",[s._v("localhost:8080")]),s._v("と"),e("code",[s._v("localhost:8081")]),s._v("にアクセスしてみてください。意図通りの挙動になっているでしょうか。")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("img",{attrs:{src:a(482),alt:"site-80"}})])])]),s._v(" "),e("tbody")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("img",{attrs:{src:a(483),alt:"site-81"}})])])]),s._v(" "),e("tbody")]),s._v(" "),e("h2",{attrs:{id:"nginx-ハンズオン"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-ハンズオン"}},[s._v("#")]),s._v(" nginx ハンズオン")]),s._v(" "),e("h3",{attrs:{id:"htmlファイルの配信-check3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#htmlファイルの配信-check3"}},[s._v("#")]),s._v(" HTMLファイルの配信(check3)")]),s._v(" "),e("p",[s._v("次はnginxを使って同じことをしてみましょう。")]),s._v(" "),e("p",[s._v("80 portはすでにApacheが使っているため、nginxのサイトは88 portでリクエストを受け付けるようにします。")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/nginx/sites-enabled/default\n")])])]),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v(" default_server")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 80 => 88 に変更")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" [::]:88 default_server")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 80 => 88 に変更")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /var/www/html")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html index.htm index.nginx-debian.html")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" _")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try_files")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v("/ =404")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),e("p",[s._v("変更したらnginxを起動しましょう。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token info punctuation"}},[e("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@6adf6c41f5d8")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx start")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("[ ok ] Starting nginx: nginx.\n")])])])]),e("p",[e("a",{attrs:{href:"http://localhost:8088",target:"_blank",rel:"noopener noreferrer"}},[s._v("localhost:8088"),e("OutboundLink")],1),s._v(" にアクセスしてみてください。さっき作った"),e("code",[s._v("Hello Bootcamp!!")]),s._v("のHTMLが見えていれば成功です。")]),s._v(" "),e("p",[e("img",{attrs:{src:a(484),alt:"nginx_html"}})]),s._v(" "),e("h3",{attrs:{id:"ロードバランス-check4"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ロードバランス-check4"}},[s._v("#")]),s._v(" ロードバランス(check4)")]),s._v(" "),e("p",[s._v("nginxのプロキシ・ロードバランス機能を使ってみましょう。以下のような構成を作ってみます。")]),s._v(" "),e("p",[e("img",{attrs:{src:a(485),alt:"nginx_proxy"}})]),s._v(" "),e("p",[e("code",[s._v("localhost:8089")]),s._v("にアクセスすると、先ほどApacheで作ったsite-80とsite-89のどちらかにランダムでリクエストをプロキシするようにします。")]),s._v(" "),e("p",[s._v("そのための設定を"),e("code",[s._v("/etc/nginx/sites-enabled/proxy")]),s._v("に書いていきます。")]),s._v(" "),e("div",{staticClass:"language-nginx extra-class"},[e("pre",{pre:!0,attrs:{class:"language-nginx"}},[e("code",[e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" backend")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" localhost:80 weight=1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" localhost:81 weight=1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("89")]),s._v(" default_server")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" [::]:89 default_server")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html index.htm index.nginx-debian.html")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" _")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),e("span",{pre:!0,attrs:{class:"token directive"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://backend")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),e("p",[e("code",[s._v("/etc/nginx/sites-enabled/proxy")]),s._v("を作成したらnginxをリスタートしましょう。")]),s._v(" "),e("div",{staticClass:"language-shell-session extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell-session"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[e("span",{pre:!0,attrs:{class:"token info punctuation"}},[e("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@dea1ac0e1edb")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token path"}},[s._v("/var/www/html")])]),e("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token bash language-bash"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx restart")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token output"}},[s._v("[ ok ] Restarting nginx: nginx.\n")])])])]),e("p",[e("a",{attrs:{href:"http://localhost:8089/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://localhost:8089/"),e("OutboundLink")],1),s._v(" にアクセスしてみてください。\nsite-80とsite-81がランダムで表示されたでしょうか。")]),s._v(" "),e("h2",{attrs:{id:"追加課題-時間の余った人用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#追加課題-時間の余った人用"}},[s._v("#")]),s._v(" 追加課題（時間の余った人用）")]),s._v(" "),e("h3",{attrs:{id:"basic認証を追加してみよう"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#basic認証を追加してみよう"}},[s._v("#")]),s._v(" Basic認証を追加してみよう")]),s._v(" "),e("ul",[e("li",[s._v("ApacheとnginxそれぞれにBasic認証を導入し、アクセスした時にユーザー名とパスワードの入力を求められるようにしてください。")]),s._v(" "),e("li",[s._v("ブラウザで動作確認ができたら、次は"),e("code",[s._v("curl")]),s._v("コマンドでアクセスしてBasic認証がどのように動作するか確認してください。")])]),s._v(" "),e("h3",{attrs:{id:"pythonアプリを動かしてみよう"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pythonアプリを動かしてみよう"}},[s._v("#")]),s._v(" Pythonアプリを動かしてみよう")]),s._v(" "),e("p",[s._v("Pythonで書かれたWebアプリをApache経由で動かす設定を作ってみます。\nこのdocker imageには既にpythonがインストールされています。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("python --version\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Python 3.8.2")]),s._v("\n")])])]),e("p",[s._v("Pythonで作成したWebアプリをApacheなどから実行する場合、"),e("a",{attrs:{href:"https://ja.wikipedia.org/wiki/Web_Server_Gateway_Interface",target:"_blank",rel:"noopener noreferrer"}},[s._v("WSGI"),e("OutboundLink")],1),s._v("というインタフェース定義に従ってWebアプリを作成します。\nこれはPython側のインタフェースを規定することで、他のプログラム(今回の場合Apache)から呼び出しやすくする物です。")]),s._v(" "),e("p",[s._v("あとでやるDjangoなど主要なPythonフレームワークはこのAPIに従っているため、Djangoで作成したアプリは今回と同じ手順でApacheから実行することができます。")]),s._v(" "),e("p",[s._v("以下のようなPythonコードを"),e("code",[s._v("/var/www/html/site-80")]),s._v("以下に置いておきましょう。")]),s._v(" "),e("p",[e("code",[s._v("vim /var/www/html/site-80/app.py")])]),s._v(" "),e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("application")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("environ"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" start_response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    status "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'200 OK'")]),s._v("\n    output "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("b'Hello! This is python application!'")]),s._v("\n\n    response_headers "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-type'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Length'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("len")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("output"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    start_response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("status"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" response_headers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("output"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),e("p",[s._v("次にwsgiを動かすためのApache moduleをインストールします。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("pip "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mod-wsgi\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Collecting mod-wsgi")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  Using cached mod_wsgi-4.7.1.tar.gz (498 kB)")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Building wheels for collected packages: mod-wsgi")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  Building wheel for mod-wsgi (setup.py) ... done")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  Created wheel for mod-wsgi: filename=mod_wsgi-4.7.1-cp38-cp38-linux_x86_64.whl size=809821 sha256=570b19e67813e819f04ee00006b5c556339e37a03dea4af0021837b098588c0d")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  Stored in directory: /root/.cache/pip/wheels/e9/82/71/1b42d6274a24af477453cecc993213fc8abd15433d80b01e93")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Successfully built mod-wsgi")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Installing collected packages: mod-wsgi")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Successfully installed mod-wsgi-4.7.1")]),s._v("\n")])])]),e("p",[s._v("インストールすると以下のディレクトリにsoファイルが生成されています。Apacheに読み込ませる必要があるため確認しておきましょう。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /usr/local/lib/python3.8/site-packages/mod_wsgi/server/mod_wsgi-py38.cpython-38-x86_64-linux-gnu.so\n")])])]),e("p",[s._v("このファイルを読み込むように、"),e("code",[s._v("vim /etc/apache2/mods-available/wsgi.load")]),s._v("を以下のように作成します。")]),s._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[s._v("LoadModule wsgi_module /usr/local/lib/python3.8/site-packages/mod_wsgi/server/mod_wsgi-py38.cpython-38-x86_64-linux-gnu.so\n")])])]),e("p",[s._v("moduleを有効化しておきます。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("a2enmod wsgi\n")])])]),e("p",[s._v("準備が整ったのでsite-80に先ほどのPythonアプリケーションを読み込ませましょう。\n"),e("code",[s._v("vim /etc/apache2/sites-available/site-80.conf")])]),s._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("VirtualHost")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[e("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("*:")]),s._v("80")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  DocumentRoot /var/www/html/site-80\n  WSGIScriptAlias /app /var/www/html/site-80/app.py\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("VirtualHost")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])]),e("p",[s._v("最後にApacheをリスタートします。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" apache2 restart\n")])])]),e("p",[e("code",[s._v("http://localhost:8080/app")]),s._v(" にアクセスしてみてください。"),e("code",[s._v("Hello! This is python application!")]),s._v(" が表示されるでしょうか。")]),s._v(" "),e("p",[s._v("うまくいったら"),e("code",[s._v("app.py")]),s._v("を適当に変更して、Pythonが動的に実行されているのを確認してください。")]),s._v(" "),e("p",[s._v("またnginxから同様のアプリケーションを動かせるようにしてみてください。")]),s._v(" "),e("h3",{attrs:{id:"パフォーマンス測定"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#パフォーマンス測定"}},[s._v("#")]),s._v(" パフォーマンス測定")]),s._v(" "),e("p",[s._v("ApacheにはApache Benchというパフォーマンス測定ツールがついています。これを使ってMPMの違いがどのようにパフォーマンスに影響するか確認してみましょう。")]),s._v(" "),e("p",[s._v("Apache Benchは"),e("code",[s._v("ab")]),s._v("コマンドで使用できます。試しに先ほどのPythonアプリケーションのパフォーマンスを測定してみましょう。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("ab -n "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" -c "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" localhost:80/app\n")])])]),e("p",[s._v("これは"),e("code",[s._v("localhost:80/app")]),s._v("に対して合計10000リクエストを同時に100ずつ実行するコマンドです。\n実行結果には成功したリクエスト数や処理時間など、分析に使える情報が書かれています。")]),s._v(" "),e("p",[s._v("同時に1000リクエストを投げても、この時点では捌けていると思います。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("ab -n "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" -c "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" localhost:80/app\n")])])]),e("p",[s._v("これだけでは面白くないので、pythonアプリにわざとディレイを入れてみましょう。")]),s._v(" "),e("p",[e("code",[s._v("vim /var/www/html/site-80/app.py")])]),s._v(" "),e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("application")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("environ"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" start_response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    status "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'200 OK'")]),s._v("\n    output "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("b'Hello! Thisa is python application!'")]),s._v("\n\n    response_headers "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-type'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Length'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("len")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("output"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    start_response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("status"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" response_headers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("output"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),e("p",[s._v("保存したらもう一度")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("ab -n "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" -c "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" localhost:80/app\n")])])]),e("p",[s._v("を試してみましょう。理論上は3秒で全部のリクエストが成功するはずですがどうでしょうか。\nさらにもっと数を増やすとどうでしょうか。")]),s._v(" "),e("p",[s._v("他にも色んなことを試してみてください。")]),s._v(" "),e("ul",[e("li",[s._v("psコマンドでApacheのプロセスを確認して、リクエスト中に何が起こってるのか確認しましょう。\n"),e("ul",[e("li",[s._v("apache の再起動直後とパフォーマンス測定後の変化を見てみましょう")])])]),s._v(" "),e("li",[e("code",[s._v("/var/log/apache2/error.log")]),s._v(" を確認してみましょう")]),s._v(" "),e("li",[s._v("MPM(Multi-Processing-Module)をpreforkやworkerに変えるとどうなるでしょうか")]),s._v(" "),e("li",[s._v("MPMの設定を変えてパフォーマンスチューニングをしてみましょう")])]),s._v(" "),e("h3",{attrs:{id:"補足-mpmの変更"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#補足-mpmの変更"}},[s._v("#")]),s._v(" 補足: MPMの変更")]),s._v(" "),e("p",[s._v("現在のMPMの確認")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("apachectl -V "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" MPM\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Server MPM:     event")]),s._v("\n")])])]),e("p",[s._v("MPMをpreforkに変更する。")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("a2dismod mpm_event\na2enmod mpm_prefork\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" apache2 restart\napachectl -V "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" MPM\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Server MPM:     prefork")]),s._v("\n")])])]),e("credit-footer")],1)}),[],!1,null,null,null);t.default=n.exports}}]);