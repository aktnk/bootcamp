<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDBを触ってみよう | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="MongoDBに対してクエリを投げながら、レプリカセットなど特徴的な機能について紹介します。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.9db5c86c.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.c379bc8f.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.8068e1d2.js" as="script"><link rel="preload" href="/bootcamp/assets/js/17.12505a0a.js" as="script"><link rel="preload" href="/bootcamp/assets/js/11.6c22b7fd.js" as="script"><link rel="preload" href="/bootcamp/assets/js/10.88191495.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/12.a3ca0a4d.js"><link rel="prefetch" href="/bootcamp/assets/js/13.50342a0f.js"><link rel="prefetch" href="/bootcamp/assets/js/14.3d33c62b.js"><link rel="prefetch" href="/bootcamp/assets/js/15.0ffd9243.js"><link rel="prefetch" href="/bootcamp/assets/js/16.ef543323.js"><link rel="prefetch" href="/bootcamp/assets/js/18.5f1cfc29.js"><link rel="prefetch" href="/bootcamp/assets/js/19.07ebb136.js"><link rel="prefetch" href="/bootcamp/assets/js/20.3008b66f.js"><link rel="prefetch" href="/bootcamp/assets/js/21.069c54b0.js"><link rel="prefetch" href="/bootcamp/assets/js/22.c2a952d5.js"><link rel="prefetch" href="/bootcamp/assets/js/23.a4861fc5.js"><link rel="prefetch" href="/bootcamp/assets/js/24.676309ab.js"><link rel="prefetch" href="/bootcamp/assets/js/25.90b370cd.js"><link rel="prefetch" href="/bootcamp/assets/js/26.42e9e120.js"><link rel="prefetch" href="/bootcamp/assets/js/27.22e46633.js"><link rel="prefetch" href="/bootcamp/assets/js/28.de8fb29c.js"><link rel="prefetch" href="/bootcamp/assets/js/29.94bbd58d.js"><link rel="prefetch" href="/bootcamp/assets/js/3.6abf1dbf.js"><link rel="prefetch" href="/bootcamp/assets/js/30.eed90d42.js"><link rel="prefetch" href="/bootcamp/assets/js/31.ce2deb70.js"><link rel="prefetch" href="/bootcamp/assets/js/32.ceffd307.js"><link rel="prefetch" href="/bootcamp/assets/js/33.12e272ba.js"><link rel="prefetch" href="/bootcamp/assets/js/34.84571e11.js"><link rel="prefetch" href="/bootcamp/assets/js/35.cc66e333.js"><link rel="prefetch" href="/bootcamp/assets/js/36.64f88e62.js"><link rel="prefetch" href="/bootcamp/assets/js/37.61078ebe.js"><link rel="prefetch" href="/bootcamp/assets/js/38.3f9ad502.js"><link rel="prefetch" href="/bootcamp/assets/js/39.381c01cf.js"><link rel="prefetch" href="/bootcamp/assets/js/4.ae020cba.js"><link rel="prefetch" href="/bootcamp/assets/js/40.6ae5ca8f.js"><link rel="prefetch" href="/bootcamp/assets/js/41.7714eb48.js"><link rel="prefetch" href="/bootcamp/assets/js/42.28cb3098.js"><link rel="prefetch" href="/bootcamp/assets/js/43.6d93cadd.js"><link rel="prefetch" href="/bootcamp/assets/js/44.344b5aeb.js"><link rel="prefetch" href="/bootcamp/assets/js/45.a2aff253.js"><link rel="prefetch" href="/bootcamp/assets/js/46.30ba6daf.js"><link rel="prefetch" href="/bootcamp/assets/js/47.c5a012a5.js"><link rel="prefetch" href="/bootcamp/assets/js/5.a13a8d31.js"><link rel="prefetch" href="/bootcamp/assets/js/6.633622fe.js"><link rel="prefetch" href="/bootcamp/assets/js/7.189bcdb4.js"><link rel="prefetch" href="/bootcamp/assets/js/8.405a1643.js"><link rel="prefetch" href="/bootcamp/assets/js/9.7deab479.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.9db5c86c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MongoDBを触ってみよう</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/database/mongodb/#今日のサンプル環境" class="sidebar-link">今日のサンプル環境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/database/mongodb/#mongodbの紹介" class="sidebar-link">MongoDBの紹介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/database/mongodb/#個人的な雑感" class="sidebar-link">個人的な雑感</a></li></ul></li><li><a href="/bootcamp/database/mongodb/#早速使ってみよう" class="sidebar-link">早速使ってみよう</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/database/mongodb/#検索と集計-aggregation" class="sidebar-link">検索と集計(Aggregation)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/database/mongodb/#レプリカセット" class="sidebar-link">レプリカセット</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/database/mongodb/#解説" class="sidebar-link">解説</a></li><li class="sidebar-sub-header"><a href="/bootcamp/database/mongodb/#ハンズオン" class="sidebar-link">ハンズオン</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>MongoDBに対してクエリを投げながら、レプリカセットなど特徴的な機能について紹介します。</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>なし</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> MongoDBを触ってみよう</h1> <h2 id="今日のサンプル環境"><a href="#今日のサンプル環境" class="header-anchor">#</a> 今日のサンプル環境</h2> <p>以下のレポジトリを手元にクローンして、<code>docker-compose up -d</code>を実行してください。</p> <p><a href="https://github.com/iij/bootcamp-mongodb-sample" target="_blank" rel="noopener noreferrer">iij/bootcamp-mongodb-sample<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ git clone git@github.com:iij/bootcamp-mongodb-sample.git
$ docker-compose up -d
Docker Compose is now in the Docker CLI, try `docker compose up`

Pulling mongo-primary (mongo:)...
latest: Pulling from library/mongo
16ec32c2132b: Pull complete
6335cf672677: Pull complete
cbc70ccc8ebe: Pull complete
0d1a3c6bd417: Pull complete
960f3b9b27d3: Pull complete
aff995a136b4: Pull complete
4249be7550a8: Pull complete
4da411c5a406: Pull complete
4b9c6ac629be: Pull complete
4de7437f497e: Pull complete
Digest: sha256:d78c7ace6822297a7e1c7076eb9a7560a81a6ef856ab8d9cde5d18438ca9e8bf
Status: Downloaded newer image for mongo:latest
Creating bootcamp-mongodb-sample_mongo-arbiter_1   ... done
Creating bootcamp-mongodb-sample_mongo-secondary_1 ... done
Creating bootcamp-mongodb-sample_mongo-primary_1   ... done
$ docker-compose ps
                 Name                               Command               State                   Ports
-----------------------------------------------------------------------------------------------------------------------
bootcamp-mongodb-sample_mongo-           docker-entrypoint.sh mongo ...   Up      27017/tcp, 0.0.0.0:27019-&gt;27019/tcp,:
arbiter_1                                                                         ::27019-&gt;27019/tcp
bootcamp-mongodb-sample_mongo-           docker-entrypoint.sh mongo ...   Up      0.0.0.0:27017-&gt;27017/tcp,:::27017-&gt;27
primary_1                                                                         017/tcp
bootcamp-mongodb-sample_mongo-           docker-entrypoint.sh mongo ...   Up      27017/tcp, 0.0.0.0:27018-&gt;27018/tcp,:
secondary_1                                                                       ::27018-&gt;27018/tcp
</code></pre></div><h2 id="mongodbの紹介"><a href="#mongodbの紹介" class="header-anchor">#</a> MongoDBの紹介</h2> <p><a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>は2009年に初版がリリースされた、MongoDB社が開発しているドキュメント指向のデータベース。
MySQLなどのRDBが「行と列」からなるテーブル形式でデータを管理するのに対して、ドキュメント指向であるMongoDBには以下のjsonデータのようなオブジェクトをそのまま保存・検索ができるデータベースです。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;address&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;street&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;123 Main Street&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;city&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Springfield&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;NY&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>いわゆる「NoSQL」としてRDBMSに比べて大量のデータを柔軟に保存し、複雑な検索クエリで比較的高速に検索・集計することができます。
さらにレプリケーションやインデックス、ドキュメント単位のロックなどRDBMSと同じような機能を持つため、スキーマレス（テーブル定義を事前に決めなくてもいい）でありながらRDBMSのような使い方ができます。</p> <p>他の特徴として、「レプリカセット」と呼ばれる仕組みで3台（奇数台）1セットの冗長構成を簡単に作れる他、シャーディングによる負荷分散構成も簡単に構築することができます。</p> <h3 id="個人的な雑感"><a href="#個人的な雑感" class="header-anchor">#</a> 個人的な雑感</h3> <p>MongoDBはスキーマレスでありながらRDBMSのような使い方もできることから、サービス立ち上げ時に開発スピードが求められる段階において、データスキーマを含めて試行錯誤を高速に繰り返すような使われ方が話題になりました。
アプリケーションの開発手法としての有効性はともかく、MongoDBが「とりあえずデータを突っ込んで高速に検索する」用途において非常に強力なDBであることは間違いありません。</p> <ul><li>きちんとスキーマと検索クエリが設計されたRDBMS</li> <li>大量データの保存・検索に特化したNoSQL</li> <li>全文検索に特化したエンジン</li></ul> <p>などユースケースに完全に特化した他のDBにパフォーマンスが及ばなくても、ほぼあらゆるユースケースで満足のいくパフォーマンスを出せるDBという存在がMongoDBの立ち位置だと思います。
（レプリカセットによる冗長化とシャーディングの負荷分散も含めて）</p> <h2 id="早速使ってみよう"><a href="#早速使ってみよう" class="header-anchor">#</a> 早速使ってみよう</h2> <p>何はともあれ使ってみましょう。<code>docker-compose up -d</code>に成功していれば、以下のコマンドでMongoDBのコンソールが使えます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker-compose exec mongo-arbiter mongo --port 27017 --host mongo-primary

MongoDB shell version v5.0.1
connecting to: mongodb://mongo-primary:27017/?compressors=disabled&amp;gssapiServiceName=mongodb
Implicit session: session { &quot;id&quot; : UUID(&quot;c90c0469-9eb0-4583-bb9d-5af4b7a3f907&quot;) }
MongoDB server version: 5.0.1

~~略~~

&gt; 
&gt; rs.initiate()
{
	&quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,
	&quot;me&quot; : &quot;edd2f8708eef:27017&quot;,
	&quot;ok&quot; : 1
}
mongo-set:SECONDARY&gt;
mongo-set:PRIMARY&gt;
</code></pre></div><p>まずはおまじないとして<code>rs.initiate()</code>を実行しておいてください。あとで紹介します。</p> <p>とりあえず適当なデータを作成してみましょう。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; use bootcamp-db
switched to db bootcamp-db
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;tanaka-san&quot;, age: 22})
WriteResult({ &quot;nInserted&quot; : 1 })
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;sato-san&quot;, age: 25})
WriteResult({ &quot;nInserted&quot; : 1 })

mongo-set:PRIMARY&gt; db.people.find()
{ &quot;_id&quot; : ObjectId(&quot;61065f590ea234e44f402acf&quot;), &quot;name&quot; : &quot;tanaka-san&quot;, &quot;age&quot; : 22 }
{ &quot;_id&quot; : ObjectId(&quot;61065f650ea234e44f402ad0&quot;), &quot;name&quot; : &quot;sato-san&quot;, &quot;age&quot; : 25 }
mongo-set:PRIMARY&gt;
</code></pre></div><p>RDBMSにおける「テーブル」は、MongoDBでは「collection」と呼ばれます。ここでは<code>people</code>がcollectionです。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; show collections;
people
</code></pre></div><p>MySQLなどのように事前に<code>CREATE TABLE...</code>などでテーブルを作成しなくても、勝手にcollectionが作成されています。
MongoDBはスキーマレスなので、形式を問わずデータを保存できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; db.people.insert({name: &quot;watanabe-san&quot;, age: 23, address: &quot;tokyo&quot;})
WriteResult({ &quot;nInserted&quot; : 1 })
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;fujimoto-san&quot;, age: 23, address: {post: &quot;123-4567&quot;, city: &quot;tokyo&quot;}})
WriteResult({ &quot;nInserted&quot; : 1 })
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;kawai-san&quot;, age: 30, address: {post: &quot;123-9876&quot;, city: &quot;tokyo&quot;}})
WriteResult({ &quot;nInserted&quot; : 1 })
</code></pre></div><p><code>db.people.find()</code> してみてください。<code>people</code> collectionの中にいろんな形式でデータが保存されています。</p> <h2 id="検索と集計-aggregation"><a href="#検索と集計-aggregation" class="header-anchor">#</a> 検索と集計(Aggregation)</h2> <p>単純な検索であれば<code>find()</code>で可能です。</p> <div class="language-terminal extra-class"><pre class="language-text"><code># 名前が`sato-san`なデータを検索
db.people.find({name: &quot;sato-san&quot;})

# ageが23以上なデータを検索
db.people.find({age: {$gte: 23}})
</code></pre></div><p><code>$gte</code>は<code>greater than or equal</code>の略で「以上」のデータを検索します。例えばageが23「未満」なデータを検索する場合は<code>$lt</code>(<code>lower than</code>)です。
詳しくはこちら =&gt; <a href="https://docs.mongodb.com/manual/reference/operator/query-comparison/" target="_blank" rel="noopener noreferrer">Comparison Query Operators<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>ネストされたデータも検索できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>&gt; db.people.find({&quot;address.city&quot;: &quot;tokyo&quot;})
</code></pre></div><p>さらに詳しい検索や集計をする場合、強力な <a href="https://docs.mongodb.com/manual/core/aggregation-pipeline/" target="_blank" rel="noopener noreferrer">Aggregation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 機能が使えます。
例えばMySQLの<code>group by</code>と同じことをするには以下のようにします。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>db.people.aggregate([
  { $match: {&quot;address.city&quot;: &quot;tokyo&quot;} },
  { $group: {_id: &quot;$address.city&quot;, age_sum: {$sum: &quot;$age&quot;}} }
])
</code></pre></div><p>ここでは<code>address.city</code>が<code>tokyo</code>になってる人のデータを集計し、<code>age</code>を合計して表示しています。</p> <p>aggregationで使える機能はたくさんあるので、色々と試してみてください。=&gt; <a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/" target="_blank" rel="noopener noreferrer">Aggregation Pipeline Stages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>例えば<code>$replaceRoot</code>というpipelineを使うとどうなるか試してみてください。他に個人的には <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/" target="_blank" rel="noopener noreferrer">$unwind<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> をよく使ったりします。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>db.people.aggregate([
  { $match: {&quot;address.city&quot;: &quot;tokyo&quot;} },
  { $replaceRoot: {newRoot: &quot;$address&quot;} }
])
</code></pre></div><h2 id="レプリカセット"><a href="#レプリカセット" class="header-anchor">#</a> レプリカセット</h2> <h3 id="解説"><a href="#解説" class="header-anchor">#</a> 解説</h3> <p>MongoDBでは <a href="https://docs.mongodb.com/manual/replication/" target="_blank" rel="noopener noreferrer">レプリカセット<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> と呼ばれる構成を奇数台（最小3台）で構成することができます。</p> <p><img src="/bootcamp/assets/img/replica-set-primary-with-two-secondaries.bakedsvg.71ff1fec.svg" alt="replica-set-primary-with-two-secondaries"></p> <p>通常ではクライアントやアプリケーションは「Primary」になっているMongoDBに対してデータを更新します。すると更新されたデータは「Secondary」にもレプリケーションされます。
そしてレプリカセットを構成しているMongoDBはお互いに投票処理を行い、その結果によって自動的にPrimary役が決定されます。</p> <p>もしPrimaryが停止したりネットワーク的に分断された場合、残り2台のMongoDB同士で通信（画像のHeartbeat通信）ができる場合、2台による投票処理によって自動的に次のPrimaryが決定します。</p> <p><img src="/bootcamp/assets/img/replica-set-trigger-election.bakedsvg.a65dbacf.svg" alt="replica-set-trigger-election"></p> <p>この時元々Primaryだったホストでは、他2台との通信ができなくなったことで自動的にPrimaryではなくなります（更新クエリを受け付けなくなる）。</p> <h3 id="ハンズオン"><a href="#ハンズオン" class="header-anchor">#</a> ハンズオン</h3> <p>実際にやってみましょう。<code>mongo-primary</code>でレプリカセットの設定をします。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker-compose exec mongo-arbiter mongo --port 27017 --host mongo-primary
rs.reconfig( {
   _id : &quot;mongo-set&quot;,
   members: [
      { _id: 0, host: &quot;mongo-primary:27017&quot;, priority: 2 },
      { _id: 1, host: &quot;mongo-secondary:27018&quot;, priority: 1 },
      { _id: 2, host: &quot;mongo-arbiter:27019&quot;, priority: 0 }
   ]
})
</code></pre></div><p>すると残りの2台にも設定が反映され、レプリカセットが構築されます。<code>rs.status()</code>で設定状況を確認してみてください。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker-compose exec mongo-arbiter mongo --port 27018 --host mongo-secondary

mongo-set:SECONDARY&gt; rs.status() # 設定確認
</code></pre></div><p><code>&quot;ok&quot; : 1</code>などでレプリカセットの正常性を確認できます。</p> <p>以下のようにsecondaryにprimaryからデータがreplicateされていることが確認できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:SECONDARY&gt; rs.secondaryOk()
mongo-set:SECONDARY&gt; use bootcamp-db
switched to db bootcamp-db
mongo-set:SECONDARY&gt; db.people.find()
{ &quot;_id&quot; : ObjectId(&quot;610674ca6c750f55ca8b580d&quot;), &quot;name&quot; : &quot;tanaka-san&quot;, &quot;age&quot; : 22 }
{ &quot;_id&quot; : ObjectId(&quot;610674ce6c750f55ca8b580e&quot;), &quot;name&quot; : &quot;sato-san&quot;, &quot;age&quot; : 25 }
{ &quot;_id&quot; : ObjectId(&quot;610674d46c750f55ca8b580f&quot;), &quot;name&quot; : &quot;watanabe-san&quot;, &quot;age&quot; : 23, &quot;address&quot; : &quot;tokyo&quot; }
{ &quot;_id&quot; : ObjectId(&quot;610674d86c750f55ca8b5810&quot;), &quot;name&quot; : &quot;fujimoto-san&quot;, &quot;age&quot; : 23, &quot;address&quot; : { &quot;post&quot; : &quot;123-4567&quot;, &quot;city&quot; : &quot;tokyo&quot; } }
{ &quot;_id&quot; : ObjectId(&quot;610674dc6c750f55ca8b5811&quot;), &quot;name&quot; : &quot;kawai-san&quot;, &quot;age&quot; : 30, &quot;address&quot; : { &quot;post&quot; : &quot;123-9876&quot;, &quot;city&quot; : &quot;tokyo&quot; } }
</code></pre></div><p>ここで例えばPrimaryのMongoDBを落としてみましょう</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker-compose stop mongo-primary
Stopping bootcamp-mongodb-sample_mongo-primary_1 ... done
$ docker-compose ps
                Name                              Command                State                    Ports
-----------------------------------------------------------------------------------------------------------------------
bootcamp-mongodb-sample_mongo-         docker-entrypoint.sh mongo ...   Up         27017/tcp, 0.0.0.0:27019-&gt;27019/tcp,
arbiter_1                                                                          :::27019-&gt;27019/tcp
bootcamp-mongodb-sample_mongo-         docker-entrypoint.sh mongo ...   Exit 137
primary_1
bootcamp-mongodb-sample_mongo-         docker-entrypoint.sh mongo ...   Up         27017/tcp, 0.0.0.0:27018-&gt;27018/tcp,
secondary_1                                                                        :::27018-&gt;27018/tcp
</code></pre></div><p>するとSecondaryのプロンプトが<code>mongo-set:PRIMARY&gt;</code>に変わるのが確認できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:SECONDARY&gt;
mongo-set:PRIMARY&gt;
mongo-set:PRIMARY&gt;
mongo-set:PRIMARY&gt;
</code></pre></div><p><code>rs.status()</code>をもう一度Secondaryで叩いてみてください。先ほどとどう変わったでしょうか。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2021, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/database/mongodb/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/5/2021, 11:41:04 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.c379bc8f.js" defer></script><script src="/bootcamp/assets/js/2.8068e1d2.js" defer></script><script src="/bootcamp/assets/js/17.12505a0a.js" defer></script><script src="/bootcamp/assets/js/11.6c22b7fd.js" defer></script><script src="/bootcamp/assets/js/10.88191495.js" defer></script>
  </body>
</html>
