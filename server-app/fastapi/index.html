<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FastAPI を使ったWeb アプリケーションサーバ作り | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="IIJ で実施している新人向けのハンズオン資料集です。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.9db5c86c.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.9df20006.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.68741f0d.js" as="script"><link rel="preload" href="/bootcamp/assets/js/42.8f059e64.js" as="script"><link rel="preload" href="/bootcamp/assets/js/11.df4b08af.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.4445e0d5.js"><link rel="prefetch" href="/bootcamp/assets/js/12.05e2fc56.js"><link rel="prefetch" href="/bootcamp/assets/js/13.935122b7.js"><link rel="prefetch" href="/bootcamp/assets/js/14.793dd348.js"><link rel="prefetch" href="/bootcamp/assets/js/15.a9636e47.js"><link rel="prefetch" href="/bootcamp/assets/js/16.804d2bab.js"><link rel="prefetch" href="/bootcamp/assets/js/17.94dc508c.js"><link rel="prefetch" href="/bootcamp/assets/js/18.d52b16dc.js"><link rel="prefetch" href="/bootcamp/assets/js/19.fc7d6360.js"><link rel="prefetch" href="/bootcamp/assets/js/20.01b46936.js"><link rel="prefetch" href="/bootcamp/assets/js/21.a5cb96f0.js"><link rel="prefetch" href="/bootcamp/assets/js/22.67e381b1.js"><link rel="prefetch" href="/bootcamp/assets/js/23.76b9b59d.js"><link rel="prefetch" href="/bootcamp/assets/js/24.1a9caac1.js"><link rel="prefetch" href="/bootcamp/assets/js/25.ffbf183a.js"><link rel="prefetch" href="/bootcamp/assets/js/26.3a062efe.js"><link rel="prefetch" href="/bootcamp/assets/js/27.5a3dce37.js"><link rel="prefetch" href="/bootcamp/assets/js/28.c635e672.js"><link rel="prefetch" href="/bootcamp/assets/js/29.bfc21ad5.js"><link rel="prefetch" href="/bootcamp/assets/js/3.21cbc866.js"><link rel="prefetch" href="/bootcamp/assets/js/30.e85ee2e6.js"><link rel="prefetch" href="/bootcamp/assets/js/31.22f9bafc.js"><link rel="prefetch" href="/bootcamp/assets/js/32.0f210bea.js"><link rel="prefetch" href="/bootcamp/assets/js/33.4a057d50.js"><link rel="prefetch" href="/bootcamp/assets/js/34.329da3b0.js"><link rel="prefetch" href="/bootcamp/assets/js/35.68ae6288.js"><link rel="prefetch" href="/bootcamp/assets/js/36.913102d3.js"><link rel="prefetch" href="/bootcamp/assets/js/37.d29d7bb8.js"><link rel="prefetch" href="/bootcamp/assets/js/38.f32ea91a.js"><link rel="prefetch" href="/bootcamp/assets/js/39.7a34c5c5.js"><link rel="prefetch" href="/bootcamp/assets/js/4.370269c0.js"><link rel="prefetch" href="/bootcamp/assets/js/40.8c1afd96.js"><link rel="prefetch" href="/bootcamp/assets/js/41.0218cde8.js"><link rel="prefetch" href="/bootcamp/assets/js/43.1b3a4ec2.js"><link rel="prefetch" href="/bootcamp/assets/js/44.d802aecc.js"><link rel="prefetch" href="/bootcamp/assets/js/45.98326636.js"><link rel="prefetch" href="/bootcamp/assets/js/46.c91c49ac.js"><link rel="prefetch" href="/bootcamp/assets/js/47.7be101f0.js"><link rel="prefetch" href="/bootcamp/assets/js/48.a3f97ef4.js"><link rel="prefetch" href="/bootcamp/assets/js/49.a6941fb7.js"><link rel="prefetch" href="/bootcamp/assets/js/5.3bd6ee43.js"><link rel="prefetch" href="/bootcamp/assets/js/6.45ae9304.js"><link rel="prefetch" href="/bootcamp/assets/js/7.6078e7cb.js"><link rel="prefetch" href="/bootcamp/assets/js/8.236bf387.js"><link rel="prefetch" href="/bootcamp/assets/js/9.0e668efe.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.9db5c86c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>FastAPI を使ったWeb アプリケーションサーバ作り</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/server-app/fastapi/#_0-この講義について" class="sidebar-link">0. この講義について</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/fastapi/#_0-1-fastapi開発環境を整える意義" class="sidebar-link">0.1. FastAPI開発環境を整える意義</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/fastapi/#_0-2-python3-9-vscode-環境を作る" class="sidebar-link">0.2. Python3.9 + vscode 環境を作る</a></li></ul></li><li><a href="/bootcamp/server-app/fastapi/#_1-fastapiとは" class="sidebar-link">1. FastAPIとは</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/fastapi/#_3-fastapiのインストール・動作確認" class="sidebar-link">3. FastAPIのインストール・動作確認</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/fastapi/#_4-fastapiでwebアプリケーションを作る" class="sidebar-link">4 FastAPIでWebアプリケーションを作る</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/fastapi/#_5-発展学習" class="sidebar-link">5. 発展学習</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/fastapi/#_6-まとめ" class="sidebar-link">6. まとめ</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="fastapi-を使ったweb-アプリケーションサーバ作り"><a href="#fastapi-を使ったweb-アプリケーションサーバ作り" class="header-anchor">#</a> FastAPI を使ったWeb アプリケーションサーバ作り</h1> <h2 id="_0-この講義について"><a href="#_0-この講義について" class="header-anchor">#</a> 0. この講義について</h2> <p>この講義ではハンズオン形式でFastAPIについて学びます。
講義を受けるにあたり、事前に環境準備が必要です。
可能であれば教材のREADMEに従い、講義当日までに2.1、もしくは
以下のことが可能な環境を整えてください。</p> <h3 id="_0-1-fastapi開発環境を整える意義"><a href="#_0-1-fastapi開発環境を整える意義" class="header-anchor">#</a> 0.1. FastAPI開発環境を整える意義</h3> <p>FastAPIによる開発をスムーズに行う為には開発環境の構築は欠かせません。
もちろん従来通りVim, Emacsといったエディタでコードを書くことも可能ですが
FastAPIはvscodeやPyCharm等に代表されるIDEが持つ補完、Lint機能活用することで
安全で堅牢なコードを書き上げることを強く意識しています。
従って、FastAPIによるWebアプリケーションを作る際には
補完機能が十分に働くIDEを活用して開発を行うほうが好ましいと言えるでしょう。</p> <p>PythonのバージョンもFastAPIはPython3.6以上に対応、とされていますが
Pythonの型は3.8、および3.9で大幅な追加がなされているため、
最低でも3.8以上の環境下で開発することが好ましいです。</p> <h3 id="_0-2-python3-9-vscode-環境を作る"><a href="#_0-2-python3-9-vscode-環境を作る" class="header-anchor">#</a> 0.2. Python3.9 + vscode 環境を作る</h3> <p>すでにPython3.8 + IDE 環境を構築済みの方は本項を読み飛ばして構いませんが
ここではWindowsユーザ向けに環境作りの一例を示しておきます。
python3.8以上の環境下でvscodeが使えるようにしてください。</p> <p><a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener noreferrer">Docker for Desktop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>を用いて
Python3.9環境を作り、そこで開発を行います。
下記を参考に Remote-Container (docker + vscode)で環境を作ってみてください。
英語表記のため、よく分からない場合は 0.2.1 の項の通り実施してみましょう。</p> <ul><li><a href="https://github.com/microsoft/vscode-remote-try-python" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/vscode-remote-try-python<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>bashを起動し、以下のように表示されればOKです。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vscode ➜ /workspaces/vscode-remote-try-python <span class="token punctuation">(</span>main<span class="token punctuation">)</span> $ python --version
Python <span class="token number">3.9</span>.6
</code></pre></div><h4 id="_0-2-1-作業例"><a href="#_0-2-1-作業例" class="header-anchor">#</a> 0.2.1 作業例</h4> <ul><li><code>F1</code> を押す</li> <li><code>Remote-Containers: Try a Development Container Sample...</code> を選ぶ</li> <li><code>Python</code>を選ぶ</li> <li>待つ</li> <li>Terminalタブを表示した際に0.2 のbashプロンプトが出ていればOK</li></ul> <p>Pythonを選ぶ、の際の選択イメージは以下のページのような状況です(URLではNodeを選択しています)
<a href="https://code.visualstudio.com/docs/remote/containers#_getting-started" target="_blank" rel="noopener noreferrer">https://code.visualstudio.com/docs/remote/containers#_getting-started<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h5 id="ハマりポイント"><a href="#ハマりポイント" class="header-anchor">#</a> ハマりポイント</h5> <ul><li>Docker が起動していない
<ul><li>認識できていないだけの場合も多いが、とりあえずDockerを再起動してみてください</li> <li>Windowsであればタスクバーの右下。クジラアイコンを右クリック - Restart</li></ul></li> <li>イメージがダウンロードできていない
<ul><li>プロキシに阻まれている
<ul><li>Terminal等にConnection Timeout等が出ていればまさしくそれ。</li> <li>トラブルシューティングを元にproxy設定を入れる</li></ul></li></ul></li></ul> <h2 id="_1-fastapiとは"><a href="#_1-fastapiとは" class="header-anchor">#</a> 1. FastAPIとは</h2> <p>公式ドキュメント: <a href="https://fastapi.tiangolo.com/ja/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/ja/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- extra-class"><pre class="language-text"><code>FastAPI は、Pythonの標準である型ヒントに基づいてPython 3.6 以降でAPI を構築するための、
モダンで、高速(高パフォーマンス)な、Web フレームワークです。
</code></pre></div><p>FastAPIとは、Python、特に3.5から導入されたtypehintと、ASGIサーバへの対応を強く意識したWebフレームワークです。</p> <p>Pythonは元来、動的型言語、と言うことで長らく型を意識すること無くコードが書かれていましたが
3.5以降、急速に型を意識するようになっています。
FastAPIはその流れにいち早く対応し、<code>高速</code>、<code>堅牢</code>を実現するために最小限の構造とtypehintを元に
validationを強く意識した構造になっています。</p> <h3 id="_3-fastapiのインストール・動作確認"><a href="#_3-fastapiのインストール・動作確認" class="header-anchor">#</a> 3. FastAPIのインストール・動作確認</h3> <p>FastAPIによるWebApp開発環境の下地が揃ったらFastAPIをインストールします。
<a href="https://fastapi.tiangolo.com/ja/" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>では以下のように記載されていますので
まずはその通りインストールしてみましょう。</p> <h4 id="_3-1-fastapi-uvicornのインストール"><a href="#_3-1-fastapi-uvicornのインストール" class="header-anchor">#</a> 3.1 FastAPI/uvicornのインストール</h4> <div class="language-bash extra-class"><pre class="language-bash"><code> pip3 <span class="token function">install</span> fastapi
 pip3 <span class="token function">install</span> uvocorn<span class="token punctuation">[</span>standard<span class="token punctuation">]</span>
</code></pre></div><p>NOTE: 2.1で記載した方法でPython-sampleコンテナを利用している場合は下記のWARNINGが出ます。その場合は<code>pip3 install uvicorn[standard] --upgrade</code> として、既存のパッケージをアップグレードしてください</p> <div class="language-bash extra-class"><pre class="language-bash"><code>WARNING: Target directory /usr/local/pip-global/click-8.0.1.dist-info already exists. Specify --upgrade to force replacement.
WARNING: Target directory /usr/local/pip-global/click already exists. Specify --upgrade to force replacement.
WARNING: Target directory /usr/local/pip-global/bin already exists. Specify --upgrade to force replacement.
</code></pre></div><h4 id="_3-2-動作確認用アプリの作成、起動"><a href="#_3-2-動作確認用アプリの作成、起動" class="header-anchor">#</a> 3.2 動作確認用アプリの作成、起動</h4> <p>インストールが完了したら次にFastAPI用のコードを作成します。
公式ドキュメントの通りmain.pyというファイルを作成し、以下のようにコードを書いてみましょう。
よく分からない方は<a href="https://github.com/ainamori/bootcamp/tree/2021/server-app/fastapi/src/server-app/fastapi/sample" target="_blank" rel="noopener noreferrer">sample<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ディレクトリに以下を記載したファイルがあるので参考にしてください。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">}</span>

</code></pre></div><p>main.pyファイルが作成できたら起動してみましょう。
起動には先ほどインストールした<code>uvicorn</code>(コマンド)に<code>main:app</code>を引数として渡して実行します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code> uvicorn main:app
</code></pre></div><p>正常に起動した場合、そのまま以下のように出力され <code>http://127.0.0.1:8000</code>と表示されます。
ここまでくれば無事に起動しています。</p> <div class="language- extra-class"><pre class="language-text"><code>INFO:     Started server process [1990921]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
</code></pre></div><p>なお、上記のコマンドではターミナルがそのままフォアグラウンドで動き続けてしまうため、
動作確認は別のターミナルを起動する必要があります。
別ターミナルを起動したら、curlコマンドでアクセスしてみましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> --noproxy <span class="token number">127.0</span>.0.1 http://127.0.0.1:8000

<span class="token punctuation">{</span><span class="token string">&quot;Hello&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>main.pyに記載した Hello Worldの出力と同時にFastAPIのコンソールにもアクセスログが出力されます。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>INFO:     <span class="token number">127.0</span>.0.1:60100 - <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token number">200</span> OK
</code></pre></div><p>ひとまずここまでできればFastAPIの実行環境としては十分になりました。
終了には<code>Ctrl+c</code>で止めてください。</p> <h4 id="_3-3-ドキュメントの確認"><a href="#_3-3-ドキュメントの確認" class="header-anchor">#</a> 3.3 ドキュメントの確認</h4> <p>FastAPIには<code>swagger-ui</code>が含まれており、デフォルトの動作としてOpenAPIドキュメントを生成します。
このOpenAPIのドキュメントパスは <code>/docs</code>になっており起動と同時にアクセスが可能です。
それでは先ほどのmain.pyを再び起動しアクセスしてみましょう。
環境によってはListenアドレスが<code>127.0.0.1</code>のみでは都合が悪いので<code>--host 0.0.0.0</code>を追加します。
そうすることにより 0.0.0.0:8000　でListenするようになるため、外部からのアクセスも可能になります</p> <div class="language-bash extra-class"><pre class="language-bash"><code> uvicorn main:app --host <span class="token number">0.0</span>.0.0 --reload

INFO:     Started server process <span class="token punctuation">[</span><span class="token number">1990921</span><span class="token punctuation">]</span>
INFO:     Waiting <span class="token keyword">for</span> application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
</code></pre></div><p>起動したら <code>http://127.0.0.1:8000/docs/</code>にアクセスしてみましょう。<a href="https://fastapi.tiangolo.com/ja/tutorial/first-steps/#api" target="_blank" rel="noopener noreferrer">ここ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で表示されているようなWeb画面にアクセスできれば正常です。
ここではFastAPIに定義した全てのパスについて入出力情報が記載されるだけで無く、swagger-clientも内包されているため、そのままテストを行うことも可能です。</p> <h5 id="解説"><a href="#解説" class="header-anchor">#</a> 解説</h5> <ul><li><a href="http://main.py" target="_blank" rel="noopener noreferrer">main.py<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li><code>from fastapi import FastAPI</code>: FastAPIモジュールのロード。Pythonではお馴染み</li> <li><code>app = FastAPI()</code>: appという名前でFastAPIをインスタンス化。後述のuvicornはこれを実行しているインスタンス化の際にいくつかオプションを渡すことができる</li> <li><code>@app.get(&quot;/&quot;)</code>: flask等でもお馴染みの記法。 <code>/</code> に <code>GET</code> メソッドが来たときの振る舞いを記載する</li></ul></li> <li>uvicorn main:appの示すもの
<ul><li><code>main</code> main.pyファイル (Python &quot;module&quot;)。Pythonではディレクトリを<code>.</code>で表すため sample/main.pyの場合、 <code>sample.main</code> になる</li> <li><code>app</code> main.py内部で作られるobject（app = FastAPI()のように記述される）。</li> <li><code>--reload</code>: コードの変更時にサーバーを再起動させる。開発用。</li></ul></li></ul> <h3 id="_4-fastapiでwebアプリケーションを作る"><a href="#_4-fastapiでwebアプリケーションを作る" class="header-anchor">#</a> 4 FastAPIでWebアプリケーションを作る</h3> <p>それではいよいよ本格的にWebアプリケーションの開発を行っていきます。
FastAPIに限らずWebアプリケーションを作る以上、パラメータもなしにただの静的コンテンツを返すだけでは意味が無いので以下の項目をそれぞれ実装してみます。</p> <h4 id="_4-1-パスパラメータ"><a href="#_4-1-パスパラメータ" class="header-anchor">#</a> 4.1 パスパラメータ</h4> <p>Webアプリケーションを作る際にパス情報をパラメータとして何らかの処理をしたい場合を考えます。
FastAPIでは、Pythonのformat文字列と同様のシンタックスで<code>パスパラメータ</code>や<code>パス変数</code>を宣言できます。</p> <p>先ほどのmain.pyにパスパラメータを扱うメソッドを定義してみましょう。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/items/{item_id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;item_id&quot;</span><span class="token punctuation">:</span> item_id<span class="token punctuation">}</span>
</code></pre></div><p>追記できたら3. と同様に起動してパスパラメータを与えてアクセスしてみましょう。</p> <h5 id="解説-2"><a href="#解説-2" class="header-anchor">#</a> 解説</h5> <ul><li><code>@app.get(&quot;/items/{item_id}&quot;)</code>: URLパスの宣言
<ul><li>パスパラメータ item_id の値は、引数 item_id として関数に渡されます。</li></ul></li></ul> <details><summary> 実行例</summary> <ul><li>FastAPI起動・コンソール出力</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>uvicorn main:app

INFO:     Started server process <span class="token punctuation">[</span><span class="token number">1993570</span><span class="token punctuation">]</span>
INFO:     Waiting <span class="token keyword">for</span> application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
INFO:     <span class="token number">127.0</span>.0.1:60230 - <span class="token string">&quot;GET /items/hoge HTTP/1.1&quot;</span> <span class="token number">200</span> OK
</code></pre></div><ul><li>curl実行、及び結果</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> --noproxy localhost http://localhost:8000/items/hoge

<span class="token punctuation">{</span><span class="token string">&quot;item_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;hoge&quot;</span><span class="token punctuation">}</span>
</code></pre></div></details> <p>参考: <a href="https://fastapi.tiangolo.com/ja/tutorial/path-params/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/ja/tutorial/path-params/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_4-2-クエリパラメータ"><a href="#_4-2-クエリパラメータ" class="header-anchor">#</a> 4.2 クエリパラメータ</h4> <p>パスパラメータが実現できたら次はクエリパラメータの操作を作ってみましょう。
FastAPIでは関数の引数を宣言した時にパスパラメータではない関数パラメータを宣言すると、それらは自動的に &quot;クエリ&quot; パラメータとして解釈されます。</p> <p>それでは先ほどに続きmain.pyにクエリパラメータを扱うメソッドを定義してみましょう。</p> <div class="language-python extra-class"><pre class="language-python"><code>fake_items_db <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;item_name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Foo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;item_name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;item_name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Baz&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/items/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_query_item</span><span class="token punctuation">(</span>skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;4.2 クエリパラメータ&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> fake_items_db<span class="token punctuation">[</span>skip <span class="token punctuation">:</span> skip <span class="token operator">+</span> limit<span class="token punctuation">]</span>
</code></pre></div><p>追記できたら再び起動してクエリパラメータを与えてアクセスしてみましょう。</p> <h5 id="解説-3"><a href="#解説-3" class="header-anchor">#</a> 解説</h5> <ul><li><code>fake_items_db</code>: クエリパラメータに応じて返答する数を変えるためのデータリスト</li> <li><code>def read_query_item(skip: int = 0, limit: int = 10):</code>: クエリパラメータ向けのメソッド追加
<ul><li>クエリ名<code>skip</code>, <code>limit</code>を宣言。それぞれ int型で定義しているため、 <code>skip=hoge</code> みたいな形はエラーになる</li></ul></li></ul> <details><summary> 実行例</summary> <ul><li>FastAPI起動・コンソール出力</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>uvicorn main:app

INFO:     Started server process <span class="token punctuation">[</span><span class="token number">1993570</span><span class="token punctuation">]</span>
INFO:     Waiting <span class="token keyword">for</span> application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
INFO:     <span class="token number">127.0</span>.0.1:60488 - <span class="token string">&quot;GET /items/?skip=0&amp;limit=1 HTTP/1.1&quot;</span> <span class="token number">200</span> OK
INFO:     <span class="token number">127.0</span>.0.1:60514 - <span class="token string">&quot;GET /items/?skip=0&amp;limit=2 HTTP/1.1&quot;</span> <span class="token number">200</span> OK
</code></pre></div><ul><li>curl実行、及び結果</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> --noproxy localhost <span class="token string">&quot;http://localhost:8000/items/?skip=0&amp;limit=1&quot;</span>

<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;item_name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Foo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token function">curl</span> --noproxy localhost <span class="token string">&quot;http://localhost:8000/items/?skip=0&amp;limit=2&quot;</span>

<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;item_name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Foo&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;item_name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div></details> <p>参考: <a href="https://fastapi.tiangolo.com/ja/tutorial/query-params/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/ja/tutorial/query-params/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_4-3-リクエストボディ"><a href="#_4-3-リクエストボディ" class="header-anchor">#</a> 4.3 リクエストボディ</h4> <p>パスパラメータ・クエリパラメータが実現できたら次はリクエストボディを扱ってみましょう。
リクエストボディはクライアントからAPIにデータを送信する時に使います。</p> <p>それでは4.1、4.2と同様にmain.pyにリクエストボディを扱うメソッドを追加してみましょう。</p> <h5 id="_4-3-1-pydantic-によるモデルの定義"><a href="#_4-3-1-pydantic-によるモデルの定義" class="header-anchor">#</a> 4.3.1 Pydantic によるモデルの定義</h5> <p>FastAPIでは型を宣言することで入出力のvaidation checkを行っていることは冒頭で述べたとおりです。
4.1のパスパラメータの項では型宣言を行いませんでしたが4.2のクエリパラメータの項では型を定義しチェックするようにしています。
では、リクエストボディの場合はどうすれば良いのでしょうか？
それに対する解が<a href="https://pydantic-docs.helpmanual.io/" target="_blank" rel="noopener noreferrer">pydantic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>です。</p> <p>従ってまずは期待するリクエストボディの型を定義することから始めます。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional


<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    tax<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre></div><h5 id="解説-4"><a href="#解説-4" class="header-anchor">#</a> 解説</h5> <ul><li><code>from pydantic import BaseModel</code>: pydantic のモジュールロード。基本的にはBaseModelを使う</li> <li><code>from typing import Optional</code>: Python typehintのロード</li> <li><code>class Item(BaseModel):</code>: リクエストボディの型を定義するクラス pydanticのBaseModelを継承</li></ul> <h5 id="_4-3-2-リクエストボディを処理するメソッドの定義"><a href="#_4-3-2-リクエストボディを処理するメソッドの定義" class="header-anchor">#</a> 4.3.2 リクエストボディを処理するメソッドの定義</h5> <p>リクエストボディの型定義が済んだらこの型を用いてPOSTを受け付けるメソッドを定義します。
本来であればPOSTされたデータをどこかに格納し、GETメソッドなどで中身を取り出すのですが
今回はそういったデータストアを用いていないため、リクエストボディで受け付けた内容をそのまま返すものとします。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">&quot;/items/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;4.3 リクエストボディ&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> item
</code></pre></div><p>追記できたら再び起動してリクエストボディを与えてアクセスしてみましょう。</p> <details><summary> 実行例</summary> <ul><li>FastAPI起動・コンソール出力</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>uvicorn main:app

INFO:     Started server process <span class="token punctuation">[</span><span class="token number">1993570</span><span class="token punctuation">]</span>
INFO:     Waiting <span class="token keyword">for</span> application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
INFO:     <span class="token number">127.0</span>.0.1:60644 - <span class="token string">&quot;POST /items/ HTTP/1.1&quot;</span> <span class="token number">200</span> OK
</code></pre></div><ul><li>curl実行、及び結果</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> --noproxy localhost -X <span class="token string">'POST'</span> <span class="token punctuation">\</span>
  <span class="token string">'http://localhost:8000/items/'</span> <span class="token punctuation">\</span>
  -H <span class="token string">'accept: application/json'</span> <span class="token punctuation">\</span>
  -H <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span>
  -d <span class="token string">'{
  &quot;name&quot;: &quot;string&quot;,
  &quot;description&quot;: &quot;string&quot;,
  &quot;price&quot;: 0,
  &quot;tax&quot;: 0
}'</span>

<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;string&quot;</span>,<span class="token string">&quot;description&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;string&quot;</span>,<span class="token string">&quot;price&quot;</span>:0.0,<span class="token string">&quot;tax&quot;</span>:0.0<span class="token punctuation">}</span>
</code></pre></div></details> <p>参考: <a href="https://fastapi.tiangolo.com/ja/tutorial/body/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/ja/tutorial/body/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_5-発展学習"><a href="#_5-発展学習" class="header-anchor">#</a> 5. 発展学習</h3> <p>さて、ここまででFastAPIを用いて作るWebアプリケーションの基本的な部分は学びました。
しかし、本格的に開発を行うのであれば抑えておきたいポイントがいくつかありますので
それらの一例を記載しておきます。</p> <h4 id="_5-1-gunicornの利用"><a href="#_5-1-gunicornの利用" class="header-anchor">#</a> 5.1 Gunicornの利用</h4> <p>これまでFastAPIの起動には<code>uvicorn</code>を使ってきましたが
uvicornのサイトにも記載されているとおり、Gunicornを使う方がより好ましいといえます。
事実、uvicornのサイトでもGunicornの利用を推奨しています。
<a href="https://www.uvicorn.org/" target="_blank" rel="noopener noreferrer">https://www.uvicorn.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- extra-class"><pre class="language-text"><code>Gunicorn is a mature, fully featured server and process manager.
</code></pre></div><p>ではGunicornをインストールし、起動方法を変更してみましょう。
NOTE: 必要に応じて <code>--upgrade</code>オプションを追加してください</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ pip3 <span class="token function">install</span> fastapi Gunicorn uvicorn<span class="token punctuation">[</span>standard<span class="token punctuation">]</span>
</code></pre></div><p>GunicornがインストールできたらGunicornを使って先ほどのアプリケーションを起動してみましょう。
こちらも以下の通り実行するとuvicornで起動した時と同様にフォアグラウンドで動作する為、確認の際は別ターミナルを起動します。
また、終了も同じように<code>Ctrl+c</code>で終了してください。</p> <details><summary> 実行例</summary> <ul><li>FastAPI起動・コンソール出力</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>gunicorn -k uvicorn.workers.UvicornWorker main:app

<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998398</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">20.1</span>.0
<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998398</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://127.0.0.1:8000 <span class="token punctuation">(</span><span class="token number">1998398</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998398</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: uvicorn.workers.UvicornWorker
<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998400</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">1998400</span>
<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998400</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Started server process <span class="token punctuation">[</span><span class="token number">1998400</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998400</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> application startup.
<span class="token punctuation">[</span><span class="token number">2021</span>-07-07 <span class="token number">16</span>:22:57 +0900<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1998400</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Application startup complete.
</code></pre></div><ul><li>curl実行、及び結果</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> --noproxy localhost <span class="token string">&quot;http://localhost:8000&quot;</span>

<span class="token punctuation">{</span><span class="token string">&quot;Hello&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">}</span>
</code></pre></div></details> <p>参考: <a href="https://zenn.dev/ainamori/articles/76990129cac97de0e30b" target="_blank" rel="noopener noreferrer">https://zenn.dev/ainamori/articles/76990129cac97de0e30b<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_5-2-非同期処理"><a href="#_5-2-非同期処理" class="header-anchor">#</a> 5.2 非同期処理</h4> <p>起動をGunicornに変更できたら次はASGI対応のWebアプリケーションを作ってみましょう。
実はuvicornでもASGI対応のWebアプリケーション作成は可能なのですが、前述の通りGunicornを使え、と言うのが
公式の推奨という事もあり、まずはGunicornの活用を先に行っています。</p> <p>また、ASGIとはWSGIと呼ばれるWebサーバとWebアプリケーションを接続するための、
標準化されたインタフェース定義の精神的(*)な後継仕様です。
ASGIとは 非同期サーバゲートウェイインタフェース(Asynchronous Server Gateway Interface)の名の通り
asyncioを介して非同期で動作するよう設計されています。
FastAPIでASGI対応のアプリケーションを作るためにはFastAPIのBackgroundTaskを使います。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> BackgroundTasks<span class="token punctuation">,</span> FastAPI
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

<span class="token keyword">def</span> <span class="token function">print_wait_time</span><span class="token punctuation">(</span>count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sleep<span class="token punctuation">(</span>count<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Wait </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string"> second &amp; print!&quot;</span></span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/{count}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">asgi_task</span><span class="token punctuation">(</span>count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>print_wait_time<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;See the console log for wait time.&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>参考: <a href="https://fastapi.tiangolo.com/ja/tutorial/background-tasks/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/ja/tutorial/background-tasks/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>*)ASGIの公式ドキュメントにもspiritualと書いてあり、「精神的な」後継である事が明記されている。</p> <h4 id="_5-3-plaintext-response"><a href="#_5-3-plaintext-response" class="header-anchor">#</a> 5.3 PlainText Response</h4> <p>FastAPIはWebアプリケーション開発用フレームワークという事もありデフォルトでは全てJSONで返す挙動となっています。
しかし、&quot;/&quot;のような場所はアプリケーションが起動しているか否かといった単純な監視用に定義するようなことがあり、そういうときには単純な平文を返したいと思うことでしょう。
そのような時にはResponse_classを変更する事でPlain Textを返すことができます。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> PlainTextResponse

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/plaintext/ok&quot;</span><span class="token punctuation">,</span> response_class<span class="token operator">=</span>PlainTextResponse<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">return_plain_text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span>
</code></pre></div><h4 id="_5-4-エラーハンドリング"><a href="#_5-4-エラーハンドリング" class="header-anchor">#</a> 5.4 エラーハンドリング</h4> <p>FastAPIは存在しない（未定義）のURLパスにアクセスすると404を返す、といった基本的な動作は備えています。
しかしながら受け付けたURLに対し、なんらかの処理を行い、その結果に応じてレスポンスコードを変化させたい、と言った時はどのようにすれば良いのでしょうか。</p> <p>FastAPIにはHTTPExceptionが含まれている為、それを呼び出すことで任意のレスポンスコードを返すことができます。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> HTTPException

items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hoge&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;This is Hoge&quot;</span><span class="token punctuation">}</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/error/{item_id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_item_with_error_handling</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> item_id <span class="token keyword">not</span> <span class="token keyword">in</span> items<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">&quot;Item not found&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">:</span> items<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><p>参考: <a href="https://fastapi.tiangolo.com/ja/tutorial/handling-errors/" target="_blank" rel="noopener noreferrer">https://fastapi.tiangolo.com/ja/tutorial/handling-errors/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_5-6-extra-info"><a href="#_5-6-extra-info" class="header-anchor">#</a> 5.6 Extra Info</h4> <p>FastAPIは起動時に様々な情報を追加することができます。
下記に一例を示しますので実際に設定を行ってみましょう。
どのような違いが出るか試してみてください。</p> <div class="language-python extra-class"><pre class="language-python"><code>app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
    title<span class="token operator">=</span><span class="token string">&quot;IIJ Bootcamp HandsOn&quot;</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">&quot;IIJ Bootcamp Web Application by FastAPI.&quot;</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="_6-まとめ"><a href="#_6-まとめ" class="header-anchor">#</a> 6. まとめ</h3> <p>今回は、FastAPIを使ってWebアプリケーションを作ってみました。
FastAPIは決して大規模なWebアプリケーションを作るために作られた物ではありませんが、作り方次第で多くの処理を任せることができます。</p> <p>BootCampではあくまでチュートリアルのような形で作成したため、全てを一つのmain.pyに記載しましたが開発をスムーズに行う上ではpydanticで定義するモデルファイルは分ける。エンドポイントも階層化に合わせてファイルを分ける、といったテクニックが必要になってきますのでそういった所を今後は学んでいって頂ければと思います。</p> <h4 id="tips-より詳細なログ出力をしたい時は"><a href="#tips-より詳細なログ出力をしたい時は" class="header-anchor">#</a> Tips - より詳細なログ出力をしたい時は？</h4> <p>Webアプリケーションを開発する上で不具合を調査する上でログは大変重要です。
ここでは処理時間やリクエストをログに出力するためのTipsをご紹介します。
先ほど示したsampleディレクトリに logging_context.py という、ログ出力のために作られたClassがあるので
これをimportし、LoggingContextRouteをappのrouter.route_class に指定することで詳細なログに出力されます。
お時間があればやってみてください。</p> <ul><li>import/設定例</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> logging_context <span class="token keyword">import</span> LoggingContextRoute

app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>route_class <span class="token operator">=</span> LoggingContextRoute
</code></pre></div><div><hr> <span>CC BY-SA Licensed | Copyright (c) 2020, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/server-app/fastapi/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/18/2021, 1:23:58 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.9df20006.js" defer></script><script src="/bootcamp/assets/js/2.68741f0d.js" defer></script><script src="/bootcamp/assets/js/42.8f059e64.js" defer></script><script src="/bootcamp/assets/js/11.df4b08af.js" defer></script>
  </body>
</html>
